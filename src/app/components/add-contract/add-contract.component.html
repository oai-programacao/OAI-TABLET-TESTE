<div class="page-container">
  <app-card-base>
    <div class="card">
       <form #contractForm="ngForm" novalidate>
      <p-stepper [(value)]="activeStep">
        <div class="btn-to-back">
          <p-button
            label="Voltar"
            severity="danger"
            icon="pi pi-arrow-left"
            (onClick)="backToSearch()"
          />
        </div>

        <!-- Aviso Global -->
        <div class="content">
          <ng-template #avisoInvalido>
            <div class="alert-warning">
              ‚ö†Ô∏è Para prosseguir, volte ao passo anterior e preencha todos os campos obrigat√≥rios.
            </div>
          </ng-template>
        </div>

         <!-- STEP 1 -->
          <p-step-item [value]="1">
            <p-step>‚Ä¢ Dados do Contrato </p-step>
            <p-step-panel>
              <ng-template #content let-activateCallback="activateCallback">
                <div ngModelGroup="step1Group" #step1Group="ngModelGroup">
                  <div class="space-stepper1">
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-ticket"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <p-select
                          [options]="plans"
                          optionLabel="label"
                          optionValue="value"
                          placeholder="Selecione"
                          name="planos"
                          [(ngModel)]="selectedPlan"
                          required
                        >
                        </p-select>
                        <label for="planos">Plano de Internet*</label>
                      </p-iftalabel>
                    </p-inputgroup>

                    <div>
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-dollar"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            id="descount"
                            name="descount"
                            type="text"
                            required
                            maxlength="18"
                            [currencyMask]="{
                              prefix: 'R$ ',
                              thousands: '.',
                              decimal: ',',
                              align: 'left'
                            }"
                            inputmode="numeric"
                            pattern="[0-9]*"
                            placeholder="R$ 0,00"
                            [maxLength]="7"
                            [(ngModel)]="contractFormData.adesion"
                          />
                          <label for="descount">Desconto de Ades√£o*</label>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>
                  </div>

                  <div class="space-stepper1">
                    <p-iftalabel>
                      <p-datepicker
                        name="dateOfStart"
                        [(ngModel)]="dateOfStart"
                        inputId="dateOfStart"
                        showIcon
                        iconDisplay="input"
                        appendTo="body"
                        #dateofStart="ngModel"
                        placeholder="dd/mm/aaaa"
                        required
                      />
                      <label for="dateOfStart">Data de In√≠cio*</label>
                    </p-iftalabel>

                    <p-iftalabel>
                      <p-datepicker
                        name="dateOfAssignment"
                        [(ngModel)]="dateOfAssignment"
                        inputId="dateOfAssignment"
                        showIcon
                        iconDisplay="input"
                        appendTo="body"
                        #dateofAssignment="ngModel"
                        placeholder="dd/mm/aaaa"
                        required
                      />
                      <label for="dateOfAssignment">Data de Assinatura*</label>
                    </p-iftalabel>

                    <div class="numbersOfInstallments">
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-sort-numeric-up"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel>
                          <p-select
                            [options]="numbersOfInstallments"
                            [(ngModel)]="selectedInstallment"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Selecione 1x a 24x"
                            name="parcelas"
                            required
                          >
                          </p-select>
                          <label for="parcelas">N√∫mero de Parcelas Ades√£o</label>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>
                  </div>
                  <div class="warn-icon-container">
                  <span
                    class="warn-icon"
                    (click)="toggle(pop3, $event)"
                    role="button"
                    aria-label="Informa√ß√£o importante"
                  >
                    !
                  </span>
                  <p-popover #pop3 [dismissable]="true">
                    <div class="warn-popup">
                      Selecione a data optada pelo cliente para vencimento do boleto
                    </div>
                  </p-popover>
                </div>

                  <div class="space-stepper2">
                    <p-iftalabel>
                      <p-select
                        [options]="typesOfDateExpirationCicle"
                        [(ngModel)]="selectDateOfExpirationCicle"
                        optionLabel="descricao"
                        optionValue="value"
                        placeholder="Selecione o dia do vencimento"
                        name="cicloFaturamento"
                        required
                      ></p-select>
                      <label for="dateofExpirationCicle">Dia de Vencimento*</label>
                    </p-iftalabel>

                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-file"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <p-select
                          name="typesOfContractOptions"
                          [(ngModel)]="selectContract"
                          [options]="typesOfContractOptions"
                          placeholder="Selecione o tipo de contrato"
                          inputId="tipoContrato"
                          required
                        ></p-select>
                        <label for="tipoContrato">Tipo de Contrato*</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <div class="space-stepper3">
                    <p-iftalabel>
                      <p-datepicker
                        name="dateOfMemberShipExpiration"
                        [(ngModel)]="dateOfMemberShipExpiration"
                        inputId="dateOfMemberShipExpiration"
                        showIcon
                        iconDisplay="input"
                        appendTo="body"
                        #dateofExpiration="ngModel"
                        placeholder="dd/mm/aaaa"
                        required
                      ></p-datepicker>
                      <label for="dateOfMemberShipExpiration"
                        >Data de Vencimento da Ades√£o*</label
                      >
                    </p-iftalabel>
                  </div>

                  <p-divider></p-divider>

                  <p class="header-title">Upload de Imagens do Contrato</p>
                  <div class="title-image-upload">
                    <input
                      type="file"
                      #fileInput
                      accept="image/*"
                      (change)="onFileSelected($event)"
                      hidden
                    />
                  </div>

                  <div class="image-upload-row">
                    <div class="image-slot" *ngFor="let slot of [0, 1, 2, 3, 4]">
                      <span
                        *ngIf="!images[slot]"
                        class="plus-icon"
                        (click)="fileInput.click()"
                        >+</span
                      >
                      <div *ngIf="images[slot]" class="image-preview">
                        <img
                          [src]="imagePreviews[slot]"
                          alt="Imagem {{ slot + 1 }}"
                          (dblclick)="viewImage(imagePreviews[slot]!)"
                        />
                        <button
                          type="button"
                          class="remove-btn"
                          (click)="removeImage(slot)"
                        >
                          ‚úï
                        </button>
                      </div>
                    </div>
                  </div>

                  <p-dialog
                    [(visible)]="previewVisible"
                    [modal]="true"
                    [style]="{ width: '90vw' }"
                  >
                    <img
                      *ngIf="previewImage"
                      [src]="previewImage"
                      alt="Preview"
                      class="preview-dialog-img"
                    />
                  </p-dialog>

                  <div class="button-content">
                    <p-button
                      label="Pr√≥ximo"
                      icon="pi pi-arrow-down"
                      iconPos="right"
                      (onClick)="goToStep(2)"
                      [raised]="true"
                      [disabled]="!isStep1Valid"
                    />
                  </div>
                </div>
              </ng-template>
            </p-step-panel>
          </p-step-item>

          <!-- STEP 2 -->
          <p-step-item [value]="2">
            <p-step>‚Ä¢ Endere√ßo do Contrato</p-step>
            <p-step-panel>
              <ng-template #content let-activateCallback="activateCallback">
                <div *ngIf="step1Completed; else avisoInvalido">
                  <div ngModelGroup="step2Group" #step2Group="ngModelGroup">
                    <div class="space-stepper1">
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map-marker"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            (blur)="searchCEP()"
                            size="large"
                            pInputText
                            id="cep"
                            autocomplete="off"
                            maxlength="9"
                            name="cep"
                            required
                            placeholder="00000-000"
                            [mask]="'00000-000'"
                            [(ngModel)]="contractFormData.address.zipCode"
                          />
                          <label for="cep">C√≥digo de Endere√ßo Postal (CEP)*</label>
                        </p-iftalabel>
                      </p-inputgroup>

                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map-marker"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            id="street"
                            autocomplete="off"
                            maxlength="60"
                            name="street"
                            required
                            [(ngModel)]="contractFormData.address.street"
                          />
                          <label for="street">Logradouro (Rua)*</label>
                        </p-iftalabel>
                      </p-inputgroup>

                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-sort-numeric-up-alt"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            type="number"
                            id="streetNumber"
                            autocomplete="off"
                            maxlength="60"
                            name="streetNumber"
                            required
                            [(ngModel)]="contractFormData.address.number"
                          />
                          <label for="streetNumber">N√∫mero do Pr√©dio*</label>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>

                    <div class="space-stepper1">
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-building"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel>
                          <p-select
                            name="typeOfResidenceOptions"
                            [(ngModel)]="selectedResidence"
                            [options]="typeOfResidenceOptions"
                            placeholder="Selecione o tipo de resid√™ncia"
                            inputId="typeResidence"
                            required
                          ></p-select>
                          <label for="typeResidence">Tipo de Resid√™ncia*</label>
                        </p-iftalabel>
                      </p-inputgroup>

                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map-marker"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            id="neighborhood"
                            autocomplete="off"
                            maxlength="60"
                            name="neighborhood"
                            required
                            [(ngModel)]="contractFormData.address.neighborhood"
                          />
                          <label for="neighborhood">Bairro*</label>
                        </p-iftalabel>
                      </p-inputgroup>

                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map-marker"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            id="cityaddress"
                            autocomplete="off"
                            maxlength="60"
                            name="cityaddress"
                            required
                            [(ngModel)]="contractFormData.address.city"
                          />
                          <label for="cityaddress">Cidade*</label>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>

                    <div class="space-stepper1">
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map-marker"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            id="complementaddress"
                            autocomplete="off"
                            maxlength="60"
                            name="complementaddress"
                            [(ngModel)]="contractFormData.address.complement"
                          />
                          <label for="complementaddress">Complemento</label>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>

                    <div class="space-stepper1">
                      <p-button
                        [size]="'large'"
                        label="Validar Cabeamento"
                        raised="true"
                        severity="warn"
                        icon="pi pi-sliders-h"
                        (onClick)="showMapDialog = true"
                      />
                    </div>

                    <div class="space2-stepper">
                      <p-iftalabel>
                        <textarea
                          pTextarea
                          id="description"
                          rows="5"
                          cols="100"
                          style="resize: none"
                          name="observation"
                          [(ngModel)]="contractFormData.observation"
                        ></textarea>
                        <label for="description">Observa√ß√£o</label>
                      </p-iftalabel>
                    </div>

                    <p-dialog
                      [(visible)]="showMapDialog"
                      [modal]="true"
                      [style]="{ width: '90vh', height: '65vh' }"
                    >
                      <app-google-maps [address]="fullAddress"></app-google-maps>
                    </p-dialog>

                    <div class="button-content">
                      <p-button
                        [size]="'large'"
                        label="Visualizar O.S"
                        raised="true"
                        severity="warn"
                        icon="pi pi-bell"
                        (onClick)="showMapDialog = true"
                      />
                      <p-button
                        [size]="'large'"
                        label="Solicitar O.S"
                        raised="true"
                        severity="warn"
                        icon="pi pi-bell"
                        (onClick)="showMapDialog = true"
                      />
                      <p-button
                        [size]="'large'"
                        label="Google Maps"
                        raised="true"
                        severity="info"
                        icon="pi pi-globe"
                        (onClick)="showMapDialog = true"
                      />
                      <p-button
                        [size]="'large'"
                        label="Voltar"
                        raised="true"
                        severity="secondary"
                        icon="pi pi-arrow-up"
                        (onClick)="activateCallback(1)"
                      />
                      <p-button
                        [size]="'large'"
                        raised="true"
                        label="Pr√≥ximo"
                        icon="pi pi-arrow-down"
                        iconPos="right"
                        [disabled]="!isStep2Valid"
                       (onClick)="goToStep(3)"
                      />
                    </div>
                  </div>
                </div>
              </ng-template>
            </p-step-panel>
          </p-step-item>


          <!-- STEP 3 -->
        <p-step-item [value]="3">
          <p-step>‚Ä¢ Assinatura Digital</p-step>
          <p-step-panel>
            <ng-template #content let-activateCallback="activateCallback">
              <div *ngIf="step1Completed && step2Completed; else avisoInvalido">
                <div class="space-stepper1">
                  <div class="fluxo-container">
                    <!-- CARD 1 -->
                    <div class="fluxo-card online">
                      <div class="fluxo-header">üñ•Ô∏è <h3>Atendimento Online</h3></div>
                      <div class="fluxo-body">
                        <p>
                          Envie o termo diretamente para assinatura online via Autentique.
                        </p>
                      </div>
                      <div class="fluxo-footer">
                        <p-button
                          label="Enviar Contrato"
                          icon="pi pi-send"
                          severity="warn"
                          [raised]="true"
                          [style]="{ padding: '2rem 4rem' }"
                        ></p-button>
                      </div>
                    </div>

                    <!-- CARD 2 -->
                    <div class="fluxo-card presencial">
                      <div class="fluxo-header">ü§ù <h3>Atendimento Presencial</h3></div>
                      <div class="fluxo-body">
                        <p>
                          Gere o termo para assinatura manual presencial.
                        </p>
                      </div>
                      <div class="fluxo-footer">
                        <p-button
                          label="Assinatura Manual"
                          icon="pi pi-file-edit"
                          severity="success"
                          [raised]="true"
                          [style]="{ padding: '2rem 4rem' }"
                          (onClick)="goToStep(4)"
                        ></p-button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="btn-to-actions">
                  <p-button
                    label="Voltar"
                    severity="secondary"
                    icon="pi pi-arrow-up"
                    (onClick)="activateCallback(2)"
                  />
                </div>
              </div>
            </ng-template>
          </p-step-panel>
        </p-step-item>

  
       
       <!-- STEP 4: Visualiza√ß√£o do Contrato -->
<p-step-item [value]="4">
  <p-step>‚Ä¢ Visualiza√ß√£o do Contrato</p-step>
  <p-step-panel>
    <ng-template #content let-activateCallback="activateCallback">

      <div *ngIf="isLoadingPreview" class="loading-overlay">
    <p-progressSpinner
        styleClass="w-6rem h-6rem"
        strokeWidth="6"
        animationDuration=".5s"
    ></p-progressSpinner>
    <span class="loading-text">
        Aguarde enquanto o PDF √© gerado...
    </span>
</div>
      <!-- Valida√ß√£o: s√≥ mostra se steps anteriores completados -->
      <div *ngIf="step1Completed && step2Completed; else avisoInvalido">

        <!-- Erro ao carregar -->
        <div *ngIf="previewLoadFailed && !isLoadingPreview" 
             class="p-mt-2 text-center p-text-danger">
          <p>
            <i class="pi pi-exclamation-triangle p-mr-1"></i>
            Falha ao carregar o preview do contrato.
          </p>
          <p-button
            label="Tentar Novamente"
            icon="pi pi-refresh"
            severity="danger"
            [outlined]="true"
            size="small"
            (click)="loadPdfPreview()">
          </p-button>
        </div>

        <!-- Visualizador PDF -->
        <div  class="pdf-preview-section">
          <!-- Altern√¢ncia entre os contratos -->
  <div class="btn-ctr">
    <p-button 
      label="Contrato de Ades√£o"
      [outlined]="activeContractType !== 'adesion'"
      severity="info"
      size="small"
      raised="true"
      (click)="setActiveContract('adesion')">
    </p-button>

    <p-button 
      label="Contrato de Perman√™ncia"
      [outlined]="activeContractType !== 'permanence'"
      severity="info"
      size="small"
      raised="true"
       (click)="setActiveContract('permanence')">
    </p-button>
  </div>
          <!-- PDF Viewer -->
  <div class="pdf-viewer p-mt-2">
    <iframe
      [src]="activeContractType === 'adesion' ? safePdfAdesionUrl : safePdfPermanentUrl"
      width="100%"
      height="600px"
      title="Visualiza√ß√£o do Contrato">
    </iframe>

          <!-- Bot√µes de A√ß√£o -->
          <div class="btn-signature">
            <p-button
              label="Assinar"
              icon="pi pi-pencil"
              severity="info"
              [rounded]="true"
              [raised]="true"
              size="small"
              (click)="abrirAssinatura()">
            </p-button>
            
            <p-button
              label="Capturar Foto"
              icon="pi pi-camera"
              severity="info"
              [rounded]="true"
              [raised]="true"
              size="small"
              (click)="cameraInput.click()">
            </p-button>
            
            <p-button
              label="Salvar PDF"
              icon="pi pi-download"
              severity="success"
              [rounded]="true"
              [raised]="true"
              size="small"
              [disabled]="!capturedSignature"
              (click)="savePdf()">
            </p-button>
          </div>
        </div>
        </div>

        <!-- Input Hidden para C√¢mera -->
        <div class="camera-section">
          <input
            type="file"
            accept="image/*"
            capture="environment"
            (change)="onFotoCapturada($event)"
            style="display: none"
            #cameraInput />
        </div>

        <!-- Bot√µes de Navega√ß√£o -->
        <div class="py-6">
          <p-button
            label="Voltar"
            icon="pi pi-arrow-left"
            severity="secondary"
            (onClick)="activateCallback(3)">
          </p-button>
          
          <p-button
            label="Finalizar Contrato"
            icon="pi pi-check"
            severity="success"
            [disabled]="!capturedSignatureAdesion || !capturedSignaturePermanence"
            (onClick)="submitContract()">
          </p-button>
        </div>
      </div>

      <!-- Aviso de steps incompletos -->
      <ng-template #avisoInvalido>
        <div class="alert-warning">
          <i class="pi pi-exclamation-triangle"></i>
          <span>Complete os passos anteriores para visualizar o contrato.</span>
        </div>
      </ng-template>

    </ng-template>
  </p-step-panel>
</p-step-item>
      </p-stepper>
        </form>
    </div>
  </app-card-base>

  <p-dialog
    header="Confirmar Foto Capturada"
    [(visible)]="isPreviewDialogVisible"
    [modal]="true"
    [style]="{ width: '90vw', 'max-width': '600px' }"
    (onHide)="limparPreview()"
  >
    <div *ngIf="thumbnailPreview" class="text-center">
      <img
        [src]="thumbnailPreview"
        alt="Preview da foto capturada"
        style="
          width: 100%;
          height: auto;
          max-height: 60vh;
          border: 1px solid #ddd;
          border-radius: 4px;
          margin-bottom: 1rem;
        "
      />
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Descartar"
        icon="pi pi-times"
        (click)="limparPreview()"
        styleClass="p-button-danger p-button-text"
      ></p-button>

      <p-button
        label="Salvar Foto"
        icon="pi pi-save"
       (click)="salvarFotoCapturada()"
        styleClass="p-button-success"
        [disabled]="!fotoCapturadaFile"
      ></p-button>
    </ng-template>
  </p-dialog>

  <p-dialog
    header="Assinatura Online üñãÔ∏è"
    [(visible)]="signDialogVisible"
     (onShow)="forceSignatureRedraw()"
    
  >
    <div class="signature-pad-container">
      <div class="signature-input">
        <p-iftalabel>
          <label for="signature">Assinatura Online (Opcional):</label>
          <ng-container *ngIf="signatureVisibleFlag">
            <app-signature-pad #signaturePadInDialog> </app-signature-pad>
          </ng-container>
        </p-iftalabel>
      </div>
    </div>

    <p-divider layout="horizontal" styleClass="p-my-3"></p-divider>

    <div class="btn-to-capture">
      <div class="btn-to-generate-contract">
        <p-button
          label="Gerar Termo Final com Assinatura"
          icon="pi pi-file-pdf"
          [outlined]="true"
          size="large"
          severity="info"
          variant="outlined"
          [loading]="isLoadingPreview"
          (onClick)="captureAndGenerate()"
        ></p-button>
      </div>
    </div>
  </p-dialog>

  <!-- MODAL -->
  <p-dialog
    header="Enviar Via WhatsApp ‚öôÔ∏è"
    [(visible)]="modalVisible"
    [modal]="true"
    [closable]="true"
    resizable="false"
    [draggable]="false"
    (onHide)="onHide()"
  >
    <div class="dialog-content">
      <div class="icon-container">
        <i class="pi pi-whatsapp whatsapp-icon"></i>
      </div>
      <div class="alert-box">
        <div class="alert-icon-circle">!</div>
        <p class="alert-text">
          Ap√≥s a assinatura do documento...
        </p>
      </div>
      <p-inputgroup>
        <p-inputgroup-addon>
          <i class="pi pi-whatsapp"></i>
        </p-inputgroup-addon>
        <input
          pInputText
          id="telefone"
          name="telefone"
          placeholder="+55 (DDD) 00000-0000"
          [(ngModel)]="phone"
          required
          mask="00000000000"
        />
      </p-inputgroup>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Cancelar" icon="pi pi-times" severity="secondary" (onClick)="onHide()"></p-button>
      <p-button
        label="Enviar"
        icon="pi pi-send"
        severity="success"
        [disabled]="!phone || phone.trim().length < 10"
        (onClick)="sendToAutentiqueSubmit()"
      ></p-button>
    </ng-template>
  </p-dialog>
</div>