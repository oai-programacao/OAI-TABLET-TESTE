<div class="page-container">
  <p-toast position="top-center"></p-toast>
  <app-card-base>
    <div class="card">
      <p-stepper [(value)]="activeStep">
        <div class="btn-to-back">
          <p-button
            label="Voltar"
            severity="danger"
            icon="pi pi-arrow-left"
            (onClick)="backToSearch()"
          />
        </div>

        <!-- Aviso Global -->
        <div class="content">
          <ng-template #avisoInvalido>
            <div class="alert-warning">
              ‚ö†Ô∏è Para prosseguir, volte ao passo anterior e preencha todos os
              campos obrigat√≥rios.
            </div>
          </ng-template>
        </div>

        <!-- STEP 1 -->
        <form #contractForm="ngForm">
          <p-step-item [value]="1">
            <p-step>‚Ä¢ Dados do Contrato </p-step>
            <p-step-panel>
              <ng-template #content let-activateCallback="activateCallback">
                <div class="space-stepper1">
                  <p-inputgroup>
                    <p-inputgroup-addon>
                      <i class="pi pi-ticket"></i>
                    </p-inputgroup-addon>
                    <p-iftalabel>
                      <p-select
                        [options]="plans"
                        [(ngModel)]="selectedPlan"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Selecione"
                        name="plans"
                        required
                        id="plan"
                        [filter]="true"
                        filterBy="label,code,name"
                      >
                      </p-select>
                      <label for="plans">Plano de Internet*</label>
                    </p-iftalabel>
                  </p-inputgroup>

                  <div>
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-dollar"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel variant="on">
                        <input
                          size="large"
                          pInputText
                          id="adesion"
                          name="adesion"
                          type="text"
                          required
                          maxlength="18"
                          [currencyMask]="{
                            prefix: 'R$ ',
                            thousands: '.',
                            decimal: ',',
                            align: 'left'
                          }"
                          inputmode="numeric"
                          pattern="[0-9]*"
                          placeholder="R$ 0,00"
                          [maxLength]="10"
                          [(ngModel)]="contractFormData.adesion"
                        />
                        <label for="adesion">Pre√ßo de Ades√£o*</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <div>
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-ticket"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          size="large"
                          pInputText
                          id="discountContract"
                          name="discountContract"
                          type="text"
                          maxlength="18"
                          [currencyMask]="{
                            prefix: 'R$ ',
                            thousands: '.',
                            decimal: ',',
                            align: 'left'
                          }"
                          inputmode="numeric"
                          pattern="[0-9]*"
                          placeholder="R$ 0,00"
                          [maxLength]="10"
                          [(ngModel)]="contractFormData.discountFixe"
                        />
                        <label for="plans">Desconto Contrato*</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>
                </div>

                <div class="space-stepper1">
                  <p-iftalabel>
                    <p-datepicker
                      name="dateOfStart"
                      [(ngModel)]="dateOfStart"
                      inputId="dateOfStart"
                      showIcon
                      iconDisplay="input"
                      appendTo="body"
                      #dateofStart="ngModel"
                      placeholder="dd/mm/aaaa"
                      [minDate]="minDate"
                      required
                    />
                    <label for="dateOfStart">Data de In√≠cio*</label>
                  </p-iftalabel>

                  <app-message-valid-forms
                    [control]="dateofStart"
                    error="minDate"
                    text="A data de in√≠cio n√£o pode ser menor que a data atual."
                  ></app-message-valid-forms>

                  <p-iftalabel>
                    <p-datepicker
                      name="dateSignature"
                      [(ngModel)]="dateSignature"
                      inputId="dateSignature"
                      showIcon
                      iconDisplay="input"
                      appendTo="body"
                      #dateOfSignature="ngModel"
                      placeholder="dd/mm/aaaa"
                      [minDate]="minDate"
                      required
                    />
                    <label for="dateSignature">Data de Assinatura*</label>
                  </p-iftalabel>

                  <app-message-valid-forms
                    [control]="dateOfSignature"
                    error="minDate"
                    text="A data de assinatura n√£o pode ser menor que a data atual."
                  ></app-message-valid-forms>

                  <div class="numbersOfInstallments">
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-sort-numeric-up"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <p-select
                          [options]="numbersOfInstallments"
                          [(ngModel)]="selectedInstallment"
                          optionLabel="label"
                          optionValue="value"
                          placeholder="Selecione 1x a 24x"
                          name="parcelas"
                          required
                        >
                        </p-select>
                        <label for="parcelas">N√∫mero de Parcelas Ades√£o</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>
                </div>
                <div class="warn-icon-container">
                  <span
                    class="warn-icon"
                    (click)="toggle(pop3, $event)"
                    role="button"
                    aria-label="Informa√ß√£o importante"
                  >
                    !
                  </span>
                  <p-popover #pop3 [dismissable]="true">
                    <div class="warn-popup">
                      Selecione a data optada pelo cliente para vencimento do
                      boleto
                    </div>
                  </p-popover>
                </div>

                <div class="space-stepper2">
                  <p-iftalabel>
                    <p-select
                      [options]="typesOfDateExpirationCicle"
                      [(ngModel)]="selectDateOfExpirationCicle"
                      optionLabel="descricao"
                      optionValue="value"
                      placeholder="Selecione o dia do vencimento"
                      name="cicloFaturamento"
                      required
                    ></p-select>
                    <label for="dateofExpirationCicle"
                      >Dia de Vencimento*</label
                    >
                  </p-iftalabel>

                  <p-inputgroup>
                    <p-inputgroup-addon>
                      <i class="pi pi-file"></i>
                    </p-inputgroup-addon>
                    <p-iftalabel>
                      <p-select
                        name="typesOfContractOptions"
                        [(ngModel)]="selectContract"
                        [options]="typesOfContractOptions"
                        placeholder="Selecione o tipo de contrato"
                        inputId="tipoContrato"
                        required
                      ></p-select>
                      <label for="tipoContrato">Tipo de Contrato*</label>
                    </p-iftalabel>
                  </p-inputgroup>
                </div>

                <div class="space-stepper3">
                  <div class="field-left">
                    <p-iftalabel>
                      <p-datepicker
                        name="dateOfMemberShipExpiration"
                        [(ngModel)]="dateOfMemberShipExpiration"
                        inputId="dateOfMemberShipExpiration"
                        showIcon
                        iconDisplay="input"
                        appendTo="body"
                        #dateofExpiration="ngModel"
                        placeholder="dd/mm/aaaa"
                        required
                        [minDate]="minDate"
                      ></p-datepicker>
                      <label for="dateOfMemberShipExpiration"
                        >Data de Vencimento da Ades√£o*</label
                      >
                    </p-iftalabel>
                  </div>

                  <div class="field-right">
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-file"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <p-select
                          name="clientTypes"
                          [(ngModel)]="selectedClientType"
                          [options]="clientTypes"
                          placeholder="Selecione o tipo Cliente"
                          inputId="clientTypes"
                          required
                        ></p-select>
                        <label for="clientTypes">Tipo de Cliente*</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <div class="field-right">
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-file"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <p-select
                          name="typeTechnology"
                          [(ngModel)]="selectedTechnology"
                          [options]="technologyTypes"
                          placeholder="Selecione a tecnologia"
                          inputId="typeTechnology"
                          required
                        ></p-select>
                        <label for="typeTechnology">Tipo de Tecnologia*</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>
                </div>

                <p-divider></p-divider>

                <p class="header-title">Upload de Imagens do Contrato</p>
                <div class="title-image-upload">
                  <input
                    type="file"
                    #fileInput
                    accept="image/*"
                    (change)="onFileSelected($event)"
                    hidden
                  />
                </div>

                <div class="image-upload-row">
                  <div class="image-slot" *ngFor="let slot of [0, 1, 2, 3, 4]">
                    <span
                      *ngIf="!images[slot]"
                      class="plus-icon"
                      (click)="fileInput.click()"
                      >+</span
                    >
                    <div *ngIf="images[slot]" class="image-preview">
                      <img
                        [src]="imagePreviews[slot]"
                        alt="Imagem {{ slot + 1 }}"
                        (dblclick)="viewImage(imagePreviews[slot]!)"
                      />
                      <button
                        type="button"
                        class="remove-btn"
                        (click)="removeImage(slot)"
                      >
                        ‚úï
                      </button>
                    </div>
                  </div>
                </div>

                <p-dialog
                  [(visible)]="previewVisible"
                  [modal]="true"
                  [style]="{ width: '90vw' }"
                >
                  <img
                    *ngIf="previewImage"
                    [src]="previewImage"
                    alt="Preview"
                    class="preview-dialog-img"
                  />
                </p-dialog>

                <div class="button-content">
                  <p-button
                    label="Arquivar"
                    raised="true"
                    severity="secondary"
                    (onClick)="archiveSaleDraft()"
                    [loading]="isArchiving"
                    icon="pi pi-inbox"
                  />
                  <p-button
                    label="Pr√≥ximo"
                    icon="pi pi-arrow-down"
                    iconPos="right"
                    (onClick)="goToStep(2)"
                    [raised]="true"
                  />
                </div>
              </ng-template>
            </p-step-panel>
          </p-step-item>

          <!-- STEP 2 -->
          <p-step-item [value]="2">
            <p-step>‚Ä¢ Endere√ßo do Contrato</p-step>
            <p-step-panel>
              <ng-template #content let-activateCallback="activateCallback">
                <div>
                  <div ngModelGroup="step2Group" #step2Group="ngModelGroup">
                    <div class="space-stepper1">
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map-marker"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            (blur)="searchCEP()"
                            size="large"
                            pInputText
                            id="cep"
                            autocomplete="off"
                            maxlength="9"
                            name="cep"
                            required
                            placeholder="00000-000"
                            [mask]="'00000-000'"
                            [(ngModel)]="contractFormData.address.zipCode"
                          />
                          <label for="cep"
                            >C√≥digo de Endere√ßo Postal (CEP)*</label
                          >
                        </p-iftalabel>
                      </p-inputgroup>

                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map-marker"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            id="street"
                            autocomplete="off"
                            maxlength="60"
                            name="street"
                            required
                            [(ngModel)]="contractFormData.address.street"
                          />
                          <label for="street">Logradouro (Rua)*</label>
                        </p-iftalabel>
                      </p-inputgroup>

                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-sort-numeric-up-alt"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            type="number"
                            id="streetNumber"
                            autocomplete="off"
                            maxlength="60"
                            name="streetNumber"
                            required
                            [(ngModel)]="contractFormData.address.number"
                          />
                          <label for="streetNumber">N√∫mero do Pr√©dio*</label>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>

                    <div class="space-stepper1">
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-building"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel>
                          <p-select
                            name="typeOfResidenceOptions"
                            [(ngModel)]="selectedResidence"
                            [options]="typeOfResidenceOptions"
                            placeholder="Selecione o tipo de resid√™ncia"
                            inputId="typeResidence"
                            required
                          ></p-select>
                          <label for="typeResidence">Tipo de Resid√™ncia*</label>
                        </p-iftalabel>
                      </p-inputgroup>

                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map-marker"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            id="neighborhood"
                            autocomplete="off"
                            maxlength="60"
                            name="neighborhood"
                            required
                            [(ngModel)]="contractFormData.address.neighborhood"
                          />
                          <label for="neighborhood">Bairro*</label>
                        </p-iftalabel>
                      </p-inputgroup>

                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map-marker"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            id="cityaddress"
                            autocomplete="off"
                            maxlength="60"
                            name="cityaddress"
                            required
                            [(ngModel)]="contractFormData.address.city"
                          />
                          <label for="cityaddress">Cidade*</label>
                        </p-iftalabel>
                      </p-inputgroup>

                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            id="state"
                            autocomplete="off"
                            maxlength="2"
                            name="state"
                            required
                            [(ngModel)]="contractFormData.address.state"
                          />
                          <label for="state">UF*</label>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>

                    <div class="space-stepper1">
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <i class="pi pi-map-marker"></i>
                        </p-inputgroup-addon>
                        <p-iftalabel variant="on">
                          <input
                            size="large"
                            pInputText
                            id="complementaddress"
                            autocomplete="off"
                            maxlength="60"
                            name="complementaddress"
                            [(ngModel)]="contractFormData.address.complement"
                          />
                          <label for="complementaddress">Complemento</label>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>

                    <div class="space-stepper1">
                      <p-button
                        [size]="'large'"
                        label="Validar Cabeamento"
                        raised="true"
                        severity="warn"
                        icon="pi pi-sliders-h"
                        (onClick)="showMapDialog = true"
                      />
                    </div>

                    <div class="space2-stepper">
                      <p-iftalabel>
                        <textarea
                          pTextarea
                          id="description"
                          rows="5"
                          cols="100"
                          style="resize: none"
                          name="observation"
                          [(ngModel)]="contractFormData.observation"
                        ></textarea>
                        <label for="description">Observa√ß√£o</label>
                      </p-iftalabel>
                    </div>

                    <p-dialog
                      [(visible)]="showMapDialog"
                      [modal]="true"
                      [style]="{ width: '90vh', height: '65vh' }"
                    >
                      <app-google-maps
                        *ngIf="showMapDialog"
                        [address]="enderecoMaps"
                      ></app-google-maps>
                    </p-dialog>

                    <div class="button-content">
                      <p-button
                        [size]="'large'"
                        label="Arquivar"
                        raised="true"
                        severity="secondary"
                        (onClick)="archiveSaleDraft()"
                        [loading]="isArchiving"
                        icon="pi pi-inbox"
                      />
                      <p-button
                        [size]="'large'"
                        label="Ver Ofertas"
                        raised="true"
                        severity="warn"
                        icon="pi pi-bell"
                        (onClick)="openDialogOs()"
                      />
                      <p-button
                        [size]="'large'"
                        label="Solicitar Oferta"
                        raised="true"
                        severity="warn"
                        icon="pi pi-bell"
                        (onClick)="dialogNewOs = true"
                      />
                      <p-button
                        [size]="'large'"
                        label="Google Maps"
                        raised="true"
                        severity="info"
                        icon="pi pi-globe"
                        (onClick)="abrirMapa()"
                      />
                      <p-button
                        [size]="'large'"
                        label="Voltar"
                        raised="true"
                        severity="secondary"
                        icon="pi pi-arrow-up"
                        (onClick)="activateCallback(1)"
                      />
                      <p-button
                        [size]="'large'"
                        raised="true"
                        label="Pr√≥ximo"
                        icon="pi pi-arrow-down"
                        iconPos="right"
                        (onClick)="goToStep(3)"
                      />
                    </div>
                  </div>
                </div>
              </ng-template>
            </p-step-panel>
          </p-step-item>
        </form>

        <!-- STEP 3 -->
        <p-step-item [value]="3">
          <p-step>‚Ä¢ Assinatura Digital</p-step>
          <p-step-panel>
            <ng-template #content let-activateCallback="activateCallback">
              <div *ngIf="step1Completed && step2Completed; else avisoInvalido">
                <div class="space-stepper1">
                  <div class="fluxo-container">
                    <!-- CARD 1 -->
                    <div class="fluxo-card online">
                      <div class="fluxo-header">
                        üñ•Ô∏è
                        <h3>Atendimento Online</h3>
                      </div>
                      <div class="fluxo-body">
                        <p>
                          Envie o termo diretamente para assinatura online via
                          Autentique. Ideal para clientes atendidos por WhatsApp
                          ou Telefone
                        </p>
                      </div>
                      <div class="fluxo-footer">
                        <p-button
                          label="Enviar Contrato"
                          icon="pi pi-send"
                          severity="warn"
                          [raised]="true"
                          (onClick)="abrirModal()"
                          [style]="{ padding: '2rem 4rem' }"
                        ></p-button>
                      </div>
                    </div>

                    <!-- CARD 2 -->
                    <div class="fluxo-card presencial">
                      <div class="fluxo-header">
                        ü§ù
                        <h3>Atendimento Presencial</h3>
                      </div>
                      <div class="fluxo-body">
                        <p>Gere o termo para assinatura manual presencial.</p>
                      </div>
                      <div class="fluxo-footer">
                        <p-button
                          label="Assinatura Manual"
                          icon="pi pi-file-edit"
                          severity="success"
                          [raised]="true"
                          [style]="{ padding: '2rem 4rem' }"
                          (onClick)="goToStep(4)"
                        ></p-button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="btn-to-actions">
                  <p-button
                    label="Voltar"
                    severity="secondary"
                    icon="pi pi-arrow-up"
                    (onClick)="activateCallback(2)"
                  />
                </div>
              </div>
            </ng-template>
          </p-step-panel>
        </p-step-item>

        <!-- STEP 4: Visualiza√ß√£o do Contrato -->
        <p-step-item [value]="4">
          <p-step>‚Ä¢ Visualiza√ß√£o do Contrato</p-step>
          <p-step-panel>
            <ng-template #content let-activateCallback="activateCallback">
              <div *ngIf="isLoadingPreview" class="loading-overlay">
                <p-progressSpinner
                  styleClass="w-6rem h-6rem"
                  strokeWidth="6"
                  animationDuration=".5s"
                ></p-progressSpinner>
                <span class="loading-text">
                  Aguarde enquanto o PDF √© gerado...
                </span>
              </div>
              <div *ngIf="isSubmitting" class="loading-overlay">
                <p-progressSpinner
                  styleClass="w-6rem h-6rem"
                  strokeWidth="6"
                  animationDuration=".5s"
                ></p-progressSpinner>
                <span class="loading-text">
                  Finalizando a venda, aguarde...
                </span>
              </div>

              <div *ngIf="step1Completed && step2Completed; else avisoInvalido">
                <div
                  *ngIf="previewLoadFailed && !isLoadingPreview"
                  class="p-mt-2 text-center p-text-danger"
                >
                  <p>
                    <i class="pi pi-exclamation-triangle p-mr-1"></i>
                    Falha ao carregar o preview do contrato.
                  </p>
                  <p-button
                    label="Tentar Novamente"
                    icon="pi pi-refresh"
                    severity="danger"
                    [outlined]="true"
                    size="small"
                    (click)="loadPdfPreview()"
                  >
                  </p-button>
                </div>

                <div class="pdf-preview-section">
                  <div class="pdf-viewer p-mt-2">
                    <iframe
                      *ngIf="safePdfPreviewUrl"
                      [src]="safePdfPreviewUrl"
                      width="100%"
                      height="600px"
                      title="Visualiza√ß√£o do Contrato"
                    >
                    </iframe>

                    <div class="btn-signature">
                      <p-button
                        label="Assinar"
                        icon="pi pi-pencil"
                        severity="warn"
                        [rounded]="true"
                        [raised]="true"
                        size="small"
                        (click)="abrirAssinatura()"
                      >
                      </p-button>

                      <p-button
                        [label]="
                          step4CapturedPhotos.length > 0
                            ? 'Ver Fotos (' + step4CapturedPhotos.length + ')'
                            : 'Capturar Foto'
                        "
                        [icon]="
                          step4CapturedPhotos.length > 0
                            ? 'pi pi-images'
                            : 'pi pi-camera'
                        "
                        [severity]="
                          step4CapturedPhotos.length > 0 ? 'info' : 'secondary'
                        "
                        [rounded]="true"
                        [raised]="true"
                        size="small"
                        (click)="handleCapturaFoto()"
                      >
                      </p-button>

                      <p-button
                        label="Salvar PDF"
                        icon="pi pi-download"
                        severity="secondary"
                        [rounded]="true"
                        [raised]="true"
                        size="small"
                        (click)="savePdf()"
                      >
                      </p-button>
                    </div>

                    <div class="finalizar">
                      <p-button
                        label="Finalizar Venda"
                        icon="pi pi-check"
                        severity="success"
                        [rounded]="true"
                        [raised]="true"
                        size="large"
                        [disabled]="
                          !(
                            capturedSignatureAdesion &&
                            capturedSignaturePermanence
                          ) && !pdfWasDownloaded
                        "
                        (onClick)="openPhoneModal()"
                      ></p-button>
                    </div>
                  </div>
                </div>

                <div class="camera-section">
                  <input
                    type="file"
                    #cameraInput
                    accept="image/*"
                    capture="environment"
                    (change)="processarFotoCapturada($event)"
                    style="display: none"
                  />
                </div>

                <div class="py-6">
                  <p-button
                    label="Voltar"
                    icon="pi pi-arrow-left"
                    severity="secondary"
                    (onClick)="activateCallback(3)"
                  >
                  </p-button>
                </div>
              </div>

              <ng-template #avisoInvalido>
                <div class="alert-warning">
                  <span>
                    ‚ö†Ô∏è Complete os passos anteriores para visualizar o
                    contrato.</span
                  >
                </div>
              </ng-template>
            </ng-template>
          </p-step-panel>
        </p-step-item>
      </p-stepper>
    </div>
  </app-card-base>

  <!-- ‚úÖ Dialog de Preview com Galeria de Thumbnails -->
  <p-dialog
    header="Fotos do Contrato"
    [(visible)]="isPreviewDialogVisible"
    [modal]="true"
    [style]="{ width: '90vw', 'max-width': '700px' }"
    [closable]="true"
    (onHide)="limparPreview()"
  >
    <!-- ‚úÖ Preview da foto capturada (grande) -->
    <div
      *ngIf="thumbnailPreview"
      class="text-center"
      style="margin-bottom: 1.5rem"
    >
      <h5 style="margin-bottom: 0.5rem; color: #495057">Preview da Foto</h5>
      <img
        [src]="thumbnailPreview"
        alt="Preview da foto capturada"
        style="
          width: 100%;
          height: auto;
          max-height: 50vh;
          border: 2px solid #ddd;
          border-radius: 8px;
        "
      />
    </div>

    <!-- ‚úÖ Galeria de thumbnails (fotos j√° salvas) -->
    <div class="captured-photos-gallery-dialog">
      <h5>Fotos Adicionadas ({{ step4CapturedPhotos.length }})</h5>
      <div class="thumbnails-row-dialog">
        <div
          class="thumbnail-item-dialog"
          *ngFor="let photo of step4CapturedPhotos; let i = index"
        >
          <img [src]="photo.preview" alt="Foto {{ i + 1 }}" />
          <button
            type="button"
            class="remove-thumbnail-btn-dialog"
            (click)="removerFotoStep4(i)"
            title="Remover foto"
          >
            ‚úï
          </button>
          <span class="thumbnail-number-dialog">{{ i + 1 }}</span>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Descartar"
        icon="pi pi-times"
        (click)="limparPreview()"
        styleClass="p-button-danger p-button-text"
      >
      </p-button>

      <p-button
        label="Tirar Outra"
        icon="pi pi-camera"
        (click)="tirarOutraFoto()"
        styleClass="p-button-secondary"
      >
      </p-button>

      <p-button
        label="Salvar Foto"
        icon="pi pi-check"
        (click)="salvarFotoContratoCapturada()"
        styleClass="p-button-success"
        [disabled]="!fotoCapturadaFile"
      >
      </p-button>

      <!-- ‚úÖ Bot√£o para fechar quando j√° tem fotos salvas -->
      <p-button
        label="Concluir"
        icon="pi pi-check-circle"
        (click)="isPreviewDialogVisible = false"
        styleClass="p-button-info"
      >
      </p-button>
    </ng-template>
  </p-dialog>

  <p-dialog
    header="Assinatura Online üñãÔ∏è"
    [(visible)]="signDialogVisible"
    (onShow)="forceSignatureRedraw()"
  >
    <div class="signature-pad-container">
      <div class="signature-input">
        <p-iftalabel>
          <label for="signature">Assinatura Online (Opcional):</label>
          <ng-container *ngIf="signatureVisibleFlag">
            <app-signature-pad
              #signaturePadInDialog
              (signatureData)="onSignatureData($event)"
            >
            </app-signature-pad>
          </ng-container>
        </p-iftalabel>
      </div>
    </div>

    <p-divider layout="horizontal" styleClass="p-my-3"></p-divider>

    <div class="btn-to-capture">
      <div class="btn-to-generate-contract">
        <p-button
          label="Gerar Termo Final com Assinatura"
          icon="pi pi-file-pdf"
          [outlined]="true"
          size="large"
          severity="info"
          variant="outlined"
          [loading]="isLoadingPreview"
          (onClick)="captureAndGenerate()"
        ></p-button>
      </div>
    </div>
  </p-dialog>

  <!-- Modal -->
  <p-dialog
    header="Enviar Via WhatsApp ‚öôÔ∏è"
    [(visible)]="modalVisible"
    [modal]="true"
    [closable]="true"
    resizable="false"
    [draggable]="false"
    (onHide)="onHide()"
  >
    <div class="dialog-content">
      <div class="icon-container">
        <i class="pi pi-whatsapp whatsapp-icon"></i>
      </div>

      <div class="alert-box">
        <div class="alert-icon-circle">!</div>
        <p class="alert-text">
          Ap√≥s a assinatura do documento pelo cliente via Autentique,<br />
          o sistema processar√° automaticamente a atualiza√ß√£o dos dados<br />
          do contrato no RBX, vincular√° um atendimento ao cliente<br />
          e anexar√° o documento assinado.<br /><br />
          Voc√™ ser√° notificado assim que a assinatura for conclu√≠da<br />
          e poder√° consultar o atendimento diretamente no cadastro do cliente.
        </p>
      </div>

      <p class="info-text">
        Certifique-se de que o n√∫mero est√° correto, caso contr√°rio, poder√° ser
        enviado para outra pessoa!<br />
        O termo ser√° enviado pela Autentique para o cliente assinar via WhatsApp
        üìÑ‚úÖ <br />
        Digite o n√∫mero no formato <strong>+55</strong> (DDD + N√∫mero).<br />
      </p>

      <p-inputgroup>
        <p-inputgroup-addon>
          <i class="pi pi-whatsapp"></i>
        </p-inputgroup-addon>

        <input
          pInputText
          id="telefone"
          name="telefone"
          placeholder="+55 (DDD) 00000-0000"
          [(ngModel)]="phoneAutentique"
          required
          [style]="{ height: '40px', 'font-size': '20px' }"
          mask="00000000000"
          prefix="+55"
          #phoneModel="ngModel"
        />
      </p-inputgroup>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        severity="secondary"
        (onClick)="onHide()"
      ></p-button>
      <p-button
        label="Enviar"
        icon="pi pi-send"
        severity="success"
        [disabled]="!phoneAutentique || phoneAutentique.trim().length < 10"
        (onClick)="sendToAutentiqueSubmit()"
      ></p-button>
    </ng-template>
  </p-dialog>
</div>

<p-dialog
  [header]="'Ofertas Dispon√≠veis'"
  [resizable]="false"
  [draggable]="false"
  [(visible)]="dialogOs"
  (onShow)="onDialogShow()"
  (onHide)="onDialogHide()"
  [style]="{
    width: '800px',
    height: '800px',
    minWidth: '800px',
    maxWidth: '800px',
    minHeight: '800px',
    maxHeight: '800px'
  }"
  class="dialogOs"
>
  <div class="linhaDropdown">
    <p-inputgroup>
      <p-inputgroup-addon>
        <i class="pi pi-ticket"></i>
      </p-inputgroup-addon>
      <p-iftalabel>
        <p-select
          [options]="cities"
          [(ngModel)]="selectedCity"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecione"
          name="cities"
          id="cities"
          (onChange)="reloadTable()"
        >
        </p-select>
        <label for="cities">Cidade</label>
      </p-iftalabel>
    </p-inputgroup>
    <p-inputgroup>
      <p-inputgroup-addon>
        <i class="pi pi-ticket"></i>
      </p-inputgroup-addon>
      <p-iftalabel>
        <p-select
          [options]="typeOs"
          [(ngModel)]="selectedTypeOs"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecione"
          name="typeOs"
          id="typeOs"
          (onChange)="reloadTable()"
        >
        </p-select>
        <label for="typeOs">Tipo de OS</label>
      </p-iftalabel>
    </p-inputgroup>
    <p-inputgroup>
      <p-inputgroup-addon>
        <i class="pi pi-ticket"></i>
      </p-inputgroup-addon>
      <p-iftalabel>
        <p-select
          [options]="periodsOs"
          [(ngModel)]="selectedPeriodOs"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecione"
          name="periodsOs"
          id="periodsOs"
          (onChange)="reloadTable()"
        >
        </p-select>
        <label for="periodsOs">Per√≠odos</label>
      </p-iftalabel>
    </p-inputgroup>
    <p-button
      icon="pi pi-eraser"
      size="large"
      severity="warn"
      rounded="true"
      raised="true"
      (onClick)="clearFiltersOs()"
    ></p-button>
  </div>
  <div class="divider">
    <p-divider></p-divider>
    <div class="os-warning-box">
      <i class="pi pi-exclamation-triangle icon-alert"></i>
      <span>
        As Ofertas de Servi√ßo s√£o recursos √∫nicos do sistema. Quando uma Oferta
        aparece como
        <span class="status-reserved">Reservada</span>, significa que outro
        vendedor est√° utilizando-a no processo de venda. Caso a venda n√£o seja
        conclu√≠da dentro de <strong class="limit-time">10 minutos</strong>, a
        Oferta poder√° ser utilizada por outro vendedor tornando ela
        <span class="status-available">Dispon√≠vel</span>. <br />Caso n√£o tenha
        Hor√°rio envie uma solicita√ß√£o para a Torre
      </span>
    </div>
  </div>
  <div class="table">
    <p-table
      #osTable
      header="OS"
      [paginator]="true"
      [rows]="8"
      [lazy]="true"
      stripedRows="true"
      (onLazyLoad)="loadOffers($event)"
      [value]="offers"
      [totalRecords]="totalRecords"
    >
      <!-- Cabe√ßalho -->
      <ng-template pTemplate="header">
        <tr>
          <th>Cidade</th>
          <th>Tipo OS</th>
          <th>Data</th>
          <th>Per√≠odo</th>
          <th>Status</th>
          <th></th>
        </tr>
      </ng-template>

      <!-- Corpo -->
      <ng-template pTemplate="body" let-offer>
        <tr>
          <td>{{ offer.city }}</td>
          <td>{{ offer.typeOfOs }}</td>
          <td>{{ offer.date }}</td>
          <td>{{ offer.period }}</td>
          <td>
            <ng-container *ngIf="offer.reserved; else available">
              <div class="reserved-box">
                <p-tag severity="warn" value="Reservado"></p-tag>

                <div class="reserved-info">
                  <div *ngIf="offer.reservedAt">
                    <i class="pi pi-calendar-plus mr-1"></i>
                    <strong> Reservado em:</strong>
                    {{ offer.reservedAt | date : "dd/MM/yyyy HH:mm" }}
                  </div>
                  <div>
                    <i class="pi pi-clock mr-1"></i>
                    <strong> At√©: </strong>
                    {{ offer.reservedUntil | date : "dd/MM/yyyy HH:mm" }}
                  </div>

                  <div>
                    <i class="pi pi-user mr-1"></i>
                    <strong> Por: </strong> {{ offer.reservedByName || "‚Äî" }}
                  </div>
                </div>
              </div>
            </ng-container>

            <ng-template #available>
              <p-tag severity="success" value="Dispon√≠vel"></p-tag>
            </ng-template>
          </td>

          <td>
            <!-- SE N√ÉO EST√Å RESERVADA -->
            <button
              *ngIf="!offer.reserved"
              pButton
              icon="pi pi-lock"
              severity="success"
              rounded="true"
              [raised]="true"
              size="small"
              (click)="reserveOffer(offer)"
            ></button>

            <!-- SE EST√Å RESERVADA -->
            <button
              *ngIf="offer.reserved"
              pButton
              icon="pi pi-unlock"
              severity="danger"
              rounded="true"
              [raised]="true"
              size="small"
              (click)="unreserveOffer(offer)"
            ></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="emptytable">
            N√£o foi encontrado nenhum resultado para essa pesquisa.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</p-dialog>

<p-dialog
  [header]="'Solicitar Oferta'"
  [resizable]="false"
  [draggable]="false"
  [(visible)]="dialogNewOs"
  (onShow)="onDialogNewOs()"
  [style]="{
    width: '400px',
    height: '400px',
    minWidth: '400px',
    maxWidth: '400px',
    minHeight: '400px',
    maxHeight: '350px'
  }"
  class="dialogOs"
>
  <div class="infoBlockOffers" *ngIf="activeBlock">
    <p>
      <i class="pi pi-info-circle mr-2"></i>
      Lembrete: As solicita√ß√µes de oferta est√£o liberadas a partir de
      <strong>{{ this.activeBlock!.initialDate || "***" }}</strong> no per√≠odo
      <strong>{{
        getOfferBlockPeriodLabel(this.activeBlock!.periodOffer)
      }}</strong
      >.
    </p>
  </div>

  <form #formNewOs="ngForm">
    <div class="inputsNewOs">
      <p-inputgroup>
        <p-inputgroup-addon>
          <i class="pi pi-ticket"></i>
        </p-inputgroup-addon>
        <p-iftalabel>
          <p-select
            [options]="typeNewOs"
            [(ngModel)]="selectedTypeNewOs"
            optionLabel="label"
            optionValue="value"
            placeholder="Selecione"
            name="typeOsNew"
            required
            id="typeOsNew"
          >
          </p-select>
          <label for="typeOsNew">Tipo OS</label>
        </p-iftalabel>
      </p-inputgroup>
      <p-inputgroup>
        <p-inputgroup-addon>
          <i class="pi pi-ticket"></i>
        </p-inputgroup-addon>
        <p-iftalabel>
          <p-select
            [options]="cities"
            [(ngModel)]="selectedNewOsCity"
            optionLabel="label"
            optionValue="value"
            placeholder="Selecione"
            name="cidadeOsNew"
            required
            id="cidadeOsNew"
          >
          </p-select>
          <label for="cidadeOsNew">Cidade</label>
        </p-iftalabel>
      </p-inputgroup>
    </div>

    <div class="inputsNewOs">
      <p-inputgroup>
        <p-inputgroup-addon>
          <i class="pi pi-ticket"></i>
        </p-inputgroup-addon>
        <p-iftalabel>
          <p-select
            [options]="periodsOs"
            [(ngModel)]="selectedPeriodOs"
            optionLabel="label"
            optionValue="value"
            placeholder="Selecione"
            name="periodoOsNew"
            required
            id="periodoOsNew"
          >
          </p-select>
          <label for="periodoOsNew">Per√≠odos</label>
        </p-iftalabel>
      </p-inputgroup>

      <div class="datepicker-wrapper">
        <p-datepicker
          id="date"
          [(ngModel)]="selectedDateNewOs"
          name="date"
          dateFormat="dd/mm/yy"
          [minDate]="minDateValue"
          [showIcon]="true"
          [disabledDays]="[0]"
          dataType="string"
          placeholder="Selecione a Data"
          appendTo="body"
          required="true"
        >
        </p-datepicker>
      </div>
    </div>

    <div class="buttonsNewOs">
      <p-button
        label="Solicitar Oferta"
        [severity]="'info'"
        [raised]="true"
        (onClick)="solicitarOs()"
      ></p-button>
    </div>
  </form>
</p-dialog>

<p-dialog
  header="Enviar informa√ß√µes ao cliente"
  [(visible)]="showPhoneDialog"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '25rem' }"
>
  <div class="flex flex-column gap-3">
    <p class="m-0">
      Por favor, informe o n√∫mero de telefone do cliente para que possamos
      enviar o link de acesso da <strong>Central do Assinante</strong>.
      <br />
      Para confirmar a venda √© necess√°rio informar um n√∫mero de telefone.
      <br />
      No seguinte formato <strong>+55 (DD) N√∫mero</strong>
    </p>

    <input
      type="text"
      pInputText
      [(ngModel)]="contractFormData.phone"
      mask="00000000000"
      prefix="+55"
      placeholder="(00) 00000-0000"
    />

    <p-divider></p-divider>

    <div class="flex justify-content-end gap-2 mt-3">
      <p-button
        label="Cancelar"
        severity="secondary"
        (onClick)="showPhoneDialog = false"
      ></p-button>

      <p-button
        label="Confirmar"
        icon="pi pi-check"
        [disabled]="contractFormData.phone!.length !== 11"
        (onClick)="confirmSendToClient()"
      ></p-button>
    </div>
  </div>
</p-dialog>
<app-check [trigger]="tocarCheck" />
