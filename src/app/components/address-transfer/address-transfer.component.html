<div class="panel-container">
   <p-toast position="top-center"></p-toast>
  <app-card-base header="Transfer√™ncia De Endere√ßo" width="auto" height="auto">
    <div class="btn-to-back">
      <p-button
        icon="pi pi-arrow-left"
        [rounded]="true"
        severity="danger"
        (onClick)="btnToBack()"
      />
    </div>
    <div class="content">
      <ng-template #avisoInvalido>
        <div class="alert-warning">
          ‚ö†Ô∏è Para prosseguir, volte ao passo anterior e preencha todos os campos
          obrigat√≥rios.
        </div>
      </ng-template>
      <p-stepper [(value)]="activeStep">
        <p-step-list>
          <p-step [value]="1">Endere√ßo</p-step>
          <p-step [value]="2">Termo de Consentimento</p-step>
          <p-step [value]="3">Assinatura</p-step>
          <p-step [value]="4">Pagamento</p-step>
        </p-step-list>
        <p-step-panels>
          <p-step-panel [value]="1">
            <ng-template #content let-activateCallback="activateCallback">
              <div>
                <p-divider>
                  <h1 class="title-address-form">Endere√ßo Atual</h1>
                </p-divider>
              </div>

              <div class="form-container">
                <div class="form-content">
                  <div class="input-content">
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-map-marker"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          type="text"
                          [mask]="'00000-000'"
                          pInputText
                          [ngModel]="currentContract.zipCode"
                          disabled
                        />
                        <label for="CEP">CEP:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <div class="input-content">
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-home"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          type="text"
                          pInputText
                          [ngModel]="currentContract.street"
                          disabled
                        />
                        <label for="address-street">Logradouro:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <div class="input-content">
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-bell"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          type="text"
                          pInputText
                          [ngModel]="currentContract.number"
                          disabled
                        />
                        <label for="address-number">N¬∞ Casa/Apartamento:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <div class="input-content">
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-building"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          type="text"
                          id="address-complement"
                          pInputText
                          [ngModel]="currentContract.complement"
                          disabled
                        />
                        <label for="address-complement">Complemento:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <!-- Cidade -->
                  <div class="input-content">
                    <p-inputgroup>
                      <p-inputgroup-addon
                        ><i class="pi pi-paperclip"></i
                      ></p-inputgroup-addon>
                      <p-iftalabel variant="on">
                        <input
                          pInputText
                          id="cidade"
                          name="cidade"
                          [ngModel]="currentContract.city"
                          #cidade="ngModel"
                          disabled
                        />
                        <label for="cidade">Cidade:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <div class="input-content">
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-map-marker"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          type="text"
                          [mask]="'AA'"
                          pInputText
                          [ngModel]="currentContract.state"
                          disabled
                        />
                        <label for="UF">UF:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <div class="text-area-content">
                    <p-iftalabel>
                      <textarea
                        style="width: 100%; height: auto"
                        disabled
                        rows="5"
                        cols="20"
                        pTextarea
                        [autoResize]="true"
                        [value]="currentContract.observation"
                      ></textarea>
                      <label for="observation">Observa√ß√£o:</label>
                    </p-iftalabel>
                  </div>
                </div>
              </div>

              <div>
                <p-divider>
                  <h1 class="title-address-form">Endere√ßo Novo</h1>
                </p-divider>
              </div>

              <form #addressNewNgForm="ngForm" class="form-container">
                <div class="form-content">
                  <!-- CEP -->
                  <div class="input-content">
                    <div class="msg-error">
                      <app-message-valid-forms
                        [control]="cep"
                        error="required"
                        text="O CEP √© obrigat√≥rio"
                      ></app-message-valid-forms>
                    </div>
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-map-marker"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          id="CEP"
                          name="cep"
                          type="text"
                          pInputText
                          [mask]="'00000-000'"
                          [(ngModel)]="addressNewForm.cep"
                          #cep="ngModel"
                          required
                          (blur)="searchCEP()"
                        />
                        <label for="CEP">CEP:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <!-- Logradouro -->
                  <div class="input-content">
                    <div class="msg-error">
                      <app-message-valid-forms
                        [control]="street"
                        error="required"
                        text="Campo obrigat√≥rio"
                      ></app-message-valid-forms>
                    </div>
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-home"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          id="address-street"
                          name="street"
                          type="text"
                          pInputText
                          [(ngModel)]="addressNewForm.street"
                          #street="ngModel"
                          required
                        />
                        <label for="address-street">Logradouro:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <!-- N√∫mero -->
                  <div class="input-content">
                    <div class="msg-error">
                      <app-message-valid-forms
                        [control]="numberFromHome"
                        error="required"
                        text="Campo obrigat√≥rio"
                      ></app-message-valid-forms>
                    </div>
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-bell"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          id="address-number"
                          name="numberFromHome"
                          type="number"
                          pInputText
                          [(ngModel)]="addressNewForm.numberFromHome"
                          #numberFromHome="ngModel"
                          required
                        />
                        <label for="address-number">N¬∞ Casa/Apartamento:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <!-- Complemento -->
                  <div class="input-content">
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-building"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          id="address-complement"
                          name="complement"
                          type="text"
                          pInputText
                          [(ngModel)]="addressNewForm.complement"
                          #complement="ngModel"
                        />
                        <label for="address-complement">Complemento:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>
                  <!-- Cidade -->
                  <div class="input-content">
                    <p-inputgroup>
                      <p-inputgroup-addon
                        ><i class="pi pi-paperclip"></i
                      ></p-inputgroup-addon>
                      <p-iftalabel variant="on">
                        <input
                          pInputText
                          id="cidade"
                          name="cidade"
                          [(ngModel)]="addressNewForm.city"
                          #cidade="ngModel"
                        />
                        <label for="cidade">Cidade</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <!-- UF -->
                  <div class="input-content">
                    <div class="msg-error">
                      <app-message-valid-forms
                        [control]="uf"
                        error="required"
                        text="UF √© obrigat√≥rio"
                      ></app-message-valid-forms>
                    </div>
                    <p-inputgroup>
                      <p-inputgroup-addon>
                        <i class="pi pi-map-marker"></i>
                      </p-inputgroup-addon>
                      <p-iftalabel>
                        <input
                          id="UF"
                          name="uf"
                          type="text"
                          pInputText
                          [mask]="'AA'"
                          [(ngModel)]="addressNewForm.uf"
                          #uf="ngModel"
                          required
                        />
                        <label for="UF">UF:</label>
                      </p-iftalabel>
                    </p-inputgroup>
                  </div>

                  <!-- Observa√ß√£o -->
                  <div class="text-area-content">
                    <p-iftalabel>
                      <textarea
                        id="observation"
                        name="observation"
                        pTextarea
                        [autoResize]="true"
                        rows="5"
                        cols="30"
                        [(ngModel)]="addressNewForm.observation"
                        #observation="ngModel"
                        style="width: 100%"
                      ></textarea>
                      <label for="observation">Observa√ß√£o:</label>
                    </p-iftalabel>
                  </div>

                  <!-- ADESAO -->
                  <p-inputgroup>
                    <p-inputgroup-addon>R$</p-inputgroup-addon>
                    <p-inputNumber
                      name="adesionValue"
                      placeholder="Valor de Ades√£o"
                      mode="decimal"
                      [minFractionDigits]="2"
                      [maxFractionDigits]="2"
                      [(ngModel)]="addressNewForm.adesionValue"
                      #adesionValue="ngModel"
                    ></p-inputNumber>
                  </p-inputgroup>
                </div>
              </form>
              <div class="btn-actions">
                <p-button
                  label="Verificar Oferta"
                  size="large"
                  severity="info"
                  icon="pi pi-check"
                  (click)="openDialog()"
                />
                <p-button
                  label="Verificar Cabeamento"
                  size="large"
                  severity="warn"
                  icon="pi pi-wifi"
                />
                <p-button
                  severity="success"
                  label="Pr√≥ximo"
                  size="large"
                  (onClick)="meuMetodoExtra(); activateCallback(2)"
                  [disabled]="
                    !cep.valid ||
                    !street.valid ||
                    !numberFromHome.valid ||
                    !uf.valid ||
                    !adesionValue.valid
                  "
                />
              </div>
            </ng-template>
          </p-step-panel>

          <p-step-panel [value]="2">
            <ng-template #content let-activateCallback="activateCallback">
              <div *ngIf="formIsValid; else avisoInvalido">
                <div class="fluxo-container">
                  <!-- CARD 1 - ONLINE -->
                  <div class="fluxo-card online">
                    <div class="fluxo-header">
                      üñ•Ô∏è
                      <h3>Atendimento Online</h3>
                    </div>
                    <div class="fluxo-body">
                      <p>
                        Envie o termo diretamente para assinatura online via
                        Autentique. Ideal para clientes atendidos por WhatsApp
                        ou Telefone
                      </p>
                    </div>
                    <div class="fluxo-footer">
                      <p-button
                        label="Enviar Contrato"
                        icon="pi pi-send"
                        severity="warn"
                        [raised]="true"
                        (onClick)="abrirModal()"
                        [style]="{ padding: '2rem 4rem' }"
                      ></p-button>
                    </div>
                  </div>

                  <!-- CARD 2 - PRESENCIAL -->
                  <div class="fluxo-card presencial">
                    <div class="fluxo-header">
                      ü§ù
                      <h3>Atendimento Presencial</h3>
                    </div>
                    <div class="fluxo-body">
                      <p>
                        Gere o termo para assinatura manual presencial. A
                        assinatura ser√° inserida automaticamente no documento.
                      </p>
                    </div>
                    <div class="fluxo-footer">
                      <p-button
                        label="Assinatura Manual"
                        icon="pi pi-file-edit"
                        severity="success"
                        [raised]="true"
                        [style]="{ padding: '2rem 4rem' }"
                        (onClick)="goToStep(3)"
                      ></p-button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-template>
          </p-step-panel>

         <p-step-panel [value]="3">
  <ng-template #content let-activateCallback="activateCallback">
    <div *ngIf="formIsValid; else avisoInvalido">

      <div class="pdf-preview-section p-mb-3">
        <div *ngIf="!safePdfPreviewUrl && !isLoadingPreview">
           <p>Clique no bot√£o para carregar a pr√©-visualiza√ß√£o do termo.</p>
           <p-button
             label="Visualizar Termo"
             icon="pi pi-eye"
             styleClass="p-button-secondary"
             (click)="loadPdfPreview()"
             [loading]="isLoadingPreview">
           </p-button>
        </div>

        <div *ngIf="isLoadingPreview" class="text-center p-py-3">
          <p-progressSpinner styleClass="w-4rem h-4rem" strokeWidth="8" animationDuration=".5s"></p-progressSpinner>
          <p>Carregando pr√©-visualiza√ß√£o...</p>
        </div>

        <div *ngIf="previewLoadFailed && !isLoadingPreview" class="p-mt-2 text-center p-text-danger">
          <p><i class="pi pi-exclamation-triangle p-mr-1"></i> Falha ao carregar o preview.</p>
          <p-button label="Tentar Novamente" icon="pi pi-refresh" styleClass="p-button-sm p-button-danger p-button-outlined" (click)="loadPdfPreview()"></p-button>
        </div>

        <div *ngIf="safePdfPreviewUrl && !isLoadingPreview" class="pdf-viewer p-mt-2">
           <p>Revise o termo abaixo. Se preferir, use as op√ß√µes do visualizador para imprimir ou salvar.</p>
           <iframe [src]="safePdfPreviewUrl" width="100%" height="350px" style="border: 1px solid #ccc;"></iframe>
           <div class="btn-signature">
           <p-button label="Recarregar Visualiza√ß√£o" icon="pi pi-refresh" styleClass="p-button-sm p-button-outlined p-mt-1" (click)="loadPdfPreview()"></p-button>
           <p-button label="Assinar" icon="pi pi-pencil" styleClass="p-button-sm"  severity="info" (click)="abrirAssinatura()" ></p-button>
        </div>
        </div>
      </div>


      <div class="btn-to-navigate">
        <p-button
          label="Voltar"
          severity="danger"
          size="large"
          (onClick)="activateCallback(2)"
        />
        <p-button
          label="Pr√≥ximo"
          severity="success"
          size="large"
          (onClick)="activateCallback(4)"
          [disabled]="!capturedSignature" 
          tooltip="√â necess√°rio capturar a assinatura online para prosseguir"
          tooltipPosition="top"
        />
      </div>
      </div>

    <ng-template #avisoInvalido>
       <div class="alert-warning">
         ‚ö†Ô∏è Para visualizar o termo e assinar, preencha corretamente os dados do endere√ßo no Passo 1.
       </div>
       <div class="btn-to-navigate p-mt-3">
         <p-button label="Voltar (Endere√ßo)" severity="danger" size="large" (onClick)="activateCallback(1)"></p-button>
       </div>
    </ng-template>

  </ng-template>
</p-step-panel>

          <p-step-panel [value]="4">
            <ng-template #content let-activateCallback="activateCallback">
              <div *ngIf="formIsValid; else avisoInvalido">
                <div class="payment-container">
                  <form #paymentNgForm="ngForm" class="payment-content">
                    <div class="input-content">
                      <div class="msg-error">
                        <app-message-valid-forms
                          [control]="title"
                          error="required"
                          text="Campo Obrigat√≥rio"
                        ></app-message-valid-forms>
                      </div>
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <span class="material-symbols-outlined"
                            >attach_money</span
                          >
                        </p-inputgroup-addon>
                        <p-iftalabel>
                          <input
                            [(ngModel)]="paymentForm.title"
                            #title="ngModel"
                            name="title"
                            id="title"
                            pInputText
                            required
                          />
                          <label for="title">T√≠tulo:</label>
                          <div></div>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>

                    <div class="input-content">
                      <div class="msg-error">
                        <app-message-valid-forms
                          [control]="dueDate"
                          error="required"
                          text="Campo Obrigat√≥rio"
                        ></app-message-valid-forms>
                      </div>
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <span class="material-symbols-outlined"
                            >calendar_clock</span
                          >
                        </p-inputgroup-addon>
                        <p-iftalabel>
                          <input
                            [(ngModel)]="paymentForm.dueDate"
                            #dueDate="ngModel"
                            name="dueDate"
                            id="due-date"
                            pInputText
                            required
                          />
                          <label for="due-date">Data de Vencimento:</label>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>

                    <div class="input-content">
                      <div class="msg-error">
                        <app-message-valid-forms
                          [control]="price"
                          error="required"
                          text="Campo Obrigat√≥rio"
                        ></app-message-valid-forms>
                      </div>
                      <p-inputgroup>
                        <p-inputgroup-addon>
                          <span class="material-symbols-outlined"
                            >attach_money</span
                          >
                        </p-inputgroup-addon>
                        <p-iftalabel>
                          <input
                            [(ngModel)]="paymentForm.price"
                            #price="ngModel"
                            name="price"
                            id="price"
                            pInputText
                            prefix="R$"
                            thousandSeparator="."
                            decimalMarker=","
                            [mask]="'separator.2'"
                            required
                          />
                          <label for="price">Valor:</label>
                        </p-iftalabel>
                      </p-inputgroup>
                    </div>
                  </form>
                  <div class="btn-actions-payment">
                    <p-button
                      label="Gerar Boleto"
                      [outlined]="true"
                      size="large"
                      severity="info"
                      icon="pi pi-file"
                    ></p-button>
                    <p-button
                      label="Enviar Por Whatsapp"
                      size="large"
                      [outlined]="true"
                      severity="success"
                      icon="pi pi-whatsapp"
                    ></p-button>
                  </div>
                  <div class="btn-to-navigate">
                    <p-button
                      label="Voltar"
                      size="large"
                      severity="danger"
                      (onClick)="activateCallback(3)"
                    />
                    <p-button
                      label="Concluir"
                      size="large"
                      icon="pi pi-check"
                      severity="success"
                      (onClick)="sendToAutomation()"
                    />
                  </div>
                </div>
              </div>
            </ng-template>
          </p-step-panel>
        </p-step-panels>
      </p-stepper>
    </div>
  </app-card-base>

  <p-dialog
  header="Assinatura Online üñãÔ∏è"
  [(visible)]="signDialogVisible"
  (onShow)="forceSignatureRedraw()"
  (onHide)="resetSignaturePad()"
>
  <div class="signature-pad-container">
    <div class="signature-input">
      <p-iftalabel style="width: 100%">
        <label for="signature">Assinatura Online (Opcional):</label>
        <ng-container *ngIf="signatureVisibleFlag">
          <app-signature-pad (signatureData)="onSignatureCaptured($event)">
          </app-signature-pad>
        </ng-container>
      </p-iftalabel>
    </div>
  </div>

  <p-divider layout="horizontal" styleClass="p-my-3"></p-divider>

  <div class="btn-to-capture">
    <div class="btn-to-generate-contract">
      <p-button
        label="Gerar Termo Final com Assinatura"
        icon="pi pi-file-pdf"
        [outlined]="true"
        size="large"
        severity="info"
        variant="outlined"
        [disabled]="!capturedSignature"
        tooltip="Capture a assinatura online para habilitar"
        tooltipPosition="top"
        (onClick)="generateConsentTermWithSignature()"
      ></p-button>
    </div>
  </div>
</p-dialog>


  <!-- Modal -->
  <p-dialog
    header="Enviar Via WhatsApp ‚öôÔ∏è"
    [(visible)]="modalVisible"
    [modal]="true"
    [closable]="true"
    resizable="false"
    [draggable]="false"
    (onHide)="onHide()"
  >
    <div class="dialog-content">
      <div class="icon-container">
        <i class="pi pi-whatsapp whatsapp-icon"></i>
      </div>

      <div class="alert-box">
        <div class="alert-icon-circle">!</div>
        <p class="alert-text">
          Ap√≥s a assinatura do documento pelo cliente via Autentique,<br />
          o sistema processar√° automaticamente a atualiza√ß√£o dos dados<br />
          do contrato no RBX, vincular√° um atendimento ao cliente<br />
          e anexar√° o documento assinado.<br /><br />
          Voc√™ ser√° notificado assim que a assinatura for conclu√≠da<br />
          e poder√° consultar o atendimento diretamente no cadastro do cliente.
        </p>
      </div>

      <!-- Mensagem informativa -->
      <p class="info-text">
        Certifique-se de que o n√∫mero est√° correto, caso contr√°rio, poder√° ser
        enviado para outra pessoa!<br />
        O termo ser√° enviado pela Autentique para o cliente assinar via WhatsApp
        üìÑ‚úÖ <br />
        Digite o n√∫mero no formato <strong>+55</strong> (DDD + N√∫mero).<br />
      </p>

      <p-inputgroup>
        <p-inputgroup-addon>
          <i class="pi pi-whatsapp"></i>
        </p-inputgroup-addon>

        <input
          pInputText
          id="telefone"
          name="telefone"
          placeholder="+55 (DDD) 00000-0000"
          [(ngModel)]="phone"
          required
          [style]="{ height: '40px', 'font-size': '20px' }"
          mask="00000000000"
          prefix="+55"
          #phoneModel="ngModel"
        />
      </p-inputgroup>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        severity="secondary"
        (onClick)="onHide()"
      ></p-button>
      <p-button
        label="Enviar"
        icon="pi pi-send"
        severity="success"
        [disabled]="!phone || phone.trim().length < 10"
        (onClick)="sendToAutentiqueSubmit()"
      ></p-button>
    </ng-template>
  </p-dialog>
</div>
