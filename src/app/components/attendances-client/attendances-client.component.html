<div class="page-container">
  <p-toast position="top-center"></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <app-card-base>
    <!-- Bot√µes de navega√ß√£o e badge fora do card com bordas, mas dentro do app-card-base -->
    <div class="btn-to-back">
      <div class="nav-buttons">
        <p-button
          icon="pi pi-arrow-left"
          [rounded]="true"
          severity="danger"
          raised="true"
          [size]="'large'"
          (onClick)="backToClient()"
        ></p-button>

        <p-button
          icon="pi pi-home"
          [rounded]="true"
          severity="info"
          raised="true"
          [size]="'large'"
          (onClick)="backToHome()"
        ></p-button>
      </div>

      <div class="stats-badge" *ngIf="attendances!.length > 0">
        <i class="pi pi-chart-line"></i>
        <span>
          {{ totalElements }} atendimento{{ totalElements !== 1 ? "s" : "" }}
        </span>
      </div>
    </div>

    <!-- Card com bordas contendo o conte√∫do principal -->
    <div class="content-card">
      <!-- Header "Atendimentos Realizados" dentro do card -->
      <div class="page-header">
        <div class="header-content">
          <h1 class="page-title">
            <i class="pi pi-check-circle"></i>
            Atendimentos Realizados
          </h1>
          <p class="page-subtitle">
            Hist√≥rico completo de intera√ß√µes com os contratos do cliente em loja
          </p>
        </div>
      </div>
      <div class="reversals-button-container">
        <p-button
          (click)="popover.toggle($event)"
          label="üîç Filtros"
          [badge]="selectedStatus ? '1' : ''"
          styleClass="filter-button"
        />

        <p-popover #popover>
          <div class="filter-panel">
            <h3 class="filter-title">Filtrar por Status</h3>

            <div class="filter-section">
              <p-select
                [options]="statusOptions"
                [(ngModel)]="selectedStatus"
                placeholder="Selecione o status"
                [style]="{ width: '100%' }"
              />
            </div>

            <div class="filter-actions">
              <p-button
                label="Limpar"
                icon="pi pi-times"
                (click)="clearFilters()"
                styleClass="p-button-text"
              />
              <p-button
                label="Aplicar"
                icon="pi pi-check"
                (click)="applyFilters(); popover.hide()"
              />
            </div>
          </div>
        </p-popover>
      </div>

      <!-- Tabela com headers horizontais tradicionais -->
      <div class="table-wrapper" *ngIf="attendances!.length > 0">
        <p-table
          [value]="attendances"
          [paginator]="true"
          [rows]="5"
          [lazy]="true"
          [paginatorDropdownAppendTo]="'body'"
          styleClass="p-datatable-striped custom-table"
          [tableStyle]="{ 'min-width': '100%' }"
          (onLazyLoad)="onPageChange($event)"
          [totalRecords]="totalElements"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>
                <i class="pi pi-hashtag"></i>
                RBX
              </th>
              <th>
                <i class="pi pi-calendar"></i>
                Status
              </th>
              <th>
                <i class="pi pi-random"></i>
                Fluxo
              </th>
              <th>
                <i class="pi pi-users"></i>
                Topico
              </th>
              <th>
                <i class="pi pi-users"></i>
                Tipo
              </th>
              <th>üôç‚Äç‚ôÇÔ∏è Vendedor</th>
              <th>
                <i class="pi pi-lightbulb"></i>
                Iniciativa
              </th>

              <th>
                <i class="pi pi-calendar"></i>
                Data/Hora Ab.
              </th>
              <th></th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-att>
            <tr class="table-row">
              <td>
                <span class="code-badge">#{{ att.codeAttendanceRbx }}</span>
              </td>
              <td>
                <div class="cell-content">
                  <span
                    class="status-badge {{
                      att.status === 'OPEN'
                        ? 'open'
                        : att.status === 'COMPLETED'
                        ? 'completed'
                        : att.status === 'PENDING'
                        ? 'pending'
                        : att.status === 'CANCELLED'
                        ? 'cancelled'
                        : ''
                    }}"
                  >
                    {{
                      att.status === "OPEN"
                        ? "Aberto"
                        : att.status === "COMPLETED"
                        ? "Finalizado"
                        : att.status === "PENDING"
                        ? "Pendente"
                        : att.status === "CANCELLED"
                        ? "Cancelado"
                        : att.status
                    }}
                  </span>
                </div>
              </td>
              <td>
                <div class="cell-content">
                  <span>{{
                    att.flow === "26"
                      ? "26 ‚Ä¢ Mudan√ßa de DV"
                      : att.flow === "36"
                      ? "36 ‚Ä¢ Susp. de contrato"
                      : att.flow === "37"
                      ? "37 ‚Ä¢ Venda"
                      : att.flow 
                      ? "17 ‚Ä¢ Cancel. Contrato"
                      : att.flow
                  }}</span>
                </div>
              </td>
              <td>
                <div class="cell-content">
                  <span>
                    {{
                      att.topic === "16"
                        ? "16 ‚Ä¢ Mudan√ßa End. Fibra"
                        : att.topic === "78"
                        ? "78 ‚Ä¢ Upgrade"
                        : att.topic === "88"
                        ? "88 ‚Ä¢ Downgrade"
                        : att.topic
                        ? "18 ‚Ä¢ Transf. Titular"
                        : att.topic
                    }}
                  </span>
                </div>
              </td>
              <td>
                <div class="cell-content">
                  <span>
                    {{
                      att.type === "T"
                        ? "T√©cnico"
                        : att.type === "A"
                        ? "Admin/Finan"
                        : att.type === "C"
                        ? "Comercial"
                        : att.type
                    }}
                  </span>
                </div>
              </td>
              <td>
                <div class="cell-content">
                  <i class="pi pi-file cell-icon subject-icon"></i>
                  <span class="text-truncate">{{ att.sellerName }}</span>
                </div>
              </td>
              <td>
                <div class="cell-content">
                  <i class="pi pi-lightbulb cell-icon initiative-icon"></i>
                  <span>{{
                    att.initiative === "C" ? "Cliente" : att.initiative
                  }}</span>
                </div>
              </td>
              <td>
                <div class="date-cell">
                  <span class="date-text">{{
                    att.openDate | date : "dd/MM/yyyy"
                  }}</span>
                  <span class="time-text">{{ att.openHour }}</span>
                </div>
              </td>
              <td>
                <p-button
                  icon="pi pi-eye"
                  severity="info"
                  [rounded]="true"
                  size="large"
                  (onClick)="verDetalhes(att)"
                  styleClass="action-btn"
                ></p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <!-- Estado vazio -->
      <div *ngIf="attendances!.length === 0" class="empty-state">
        <div class="empty-content">
          <h2 class="empty-title">
            <i class="pi pi-inbox"></i>
            Nenhum Atendimento Encontrado
          </h2>
          <p class="empty-description">
            N√£o h√° registros de atendimentos para este cliente no momento.
          </p>
          <p-button
            icon="pi pi-arrow-left"
            label="Voltar para Cliente"
            severity="info"
            [rounded]="true"
            (onClick)="backToClient()"
          ></p-button>
        </div>
      </div>
    </div>
  </app-card-base>
</div>

<!-- Dialog de detalhes -->
<p-dialog
  header="Detalhes do Atendimento"
  [(visible)]="displayDialog"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  resizable="false"
  [style]="{ width: '900px', maxWidth: '90vw' }"
  styleClass="custom-dialog"
>
  <div *ngIf="selectedAttendance" class="dialog-content">
    <div class="dialog-header-info">
      <div class="info-badge">
        <i class="pi pi-hashtag"></i>
        <span>RBX: {{ selectedAttendance.codeAttendanceRbx }}</span>
      </div>
      <div class="info-badge">
        <i class="pi pi-hashtag"></i>
        <span>Vendedor Respons√°vel: {{ selectedAttendance.sellerName }}</span>
      </div>
      <div class="info-badge">
        <i class="pi pi-calendar"></i>
        <span
          >{{ selectedAttendance.openDate | date : "dd/MM/yyyy" }}
          {{ selectedAttendance.openHour }}</span
        >
      </div>

      <div class="info-badge">
        <p-button
          severity="danger"
          [raised]="true"
          icon="pi pi-times"
          label="Cancelar"
          (onClick)="confirmCancel(selectedAttendance)"
        >
        </p-button>
      </div>
    </div>

    <div class="dialog-section">
      <h3 class="section-title">
        <i class="pi pi-align-left"></i>
        Descri√ß√£o
      </h3>
      <div class="description-box">
        <p
          style="white-space: pre-line"
          [innerHTML]="
            selectedAttendance.subject || 'Sem descri√ß√£o dispon√≠vel' | linkify
          "
        ></p>
      </div>
    </div>

    <div class="dialog-section">
      <h3 class="section-title">
        <i class="pi pi-align-left"></i>
        Solu√ß√£o
      </h3>
      <div class="description-box">
        <p style="white-space: pre-line">
          {{
            selectedAttendance.solution || "N√£o h√° nada para ser exibido aqui"
          }}
        </p>
      </div>
    </div>

    <div class="dialog-section">
      <h3 class="section-title">
        <i class="pi pi-paperclip"></i>
        Arquivos Anexados
      </h3>

      <div
        *ngIf="selectedAttendance.medias!.length > 0; else noMedia"
        class="media-list"
      >
        <div *ngFor="let file of selectedAttendance.medias" class="media-item">
          <div class="media-icon">
            <i class="pi pi-file-pdf"></i>
          </div>

          <!-- Nome do arquivo -->
          <div class="media-info">
            {{ file.nameFile }}
          </div>

          <!-- Bot√£o azul para abrir PDF -->
          <div class="media-action">
            <button
              pButton
              type="button"
              icon="pi pi-external-link"
              (click)="openPdf(file.urlFile)"
              class="p-button-rounded p-button-info"
            ></button>
          </div>
        </div>
      </div>

      <ng-template #noMedia>
        <div class="no-media">
          <i class="pi pi-inbox"></i>
          <p>Nenhum arquivo anexado a este atendimento.</p>
        </div>
      </ng-template>
    </div>
  </div>
</p-dialog>

<app-check [trigger]="tocarCheck" />

<app-pdf-viewer-dialog
  [(visible)]="pdfDialogVisible"
  [pdfUrl]="pdfUrl"
></app-pdf-viewer-dialog>
