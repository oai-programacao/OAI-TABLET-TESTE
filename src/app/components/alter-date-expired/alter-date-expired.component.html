<div class="page-container">
  <app-card-base header="Alterar Data de Pagamento" width="auto" height="auto">
    <div class="btn-to-back">
      <p-button
        icon="pi pi-arrow-left"
        [rounded]="true"
        severity="danger"
        raised="true"
        size="large"
        (onClick)="voltarParaCliente()"
      />

      <p-button
        icon="pi pi-home"
        [rounded]="true"
        severity="info"
        raised="true"
        size="large"
        (onClick)="backToHome()"
      />
    </div>

    <p-stepper [value]="1">
      <p-step-list>
        <p-step [value]="1">Selecionar datas</p-step>
        <p-step [value]="2">Termo de Consentimento</p-step>
        <p-step [value]="3">Assinatura</p-step>
        <p-step [value]="4">Pagamento</p-step>
      </p-step-list>

      <p-step-panels>
        <p-step-panel [value]="1">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step step1">
              <!-- Conte√∫do -->
              <div class="step-content">
                <div class="info-item">
                  <span class="label">Valores Atuais</span>
                  <div class="value">
                    <div class="value-row">
                      <i class="pi pi-dollar"></i>
                      <span
                        >Bruto:
                        {{ contract.brutePrice | number : "1.2-2" }}</span
                      >
                    </div>

                    <div class="value-row">
                      <i class="pi pi-dollar"></i>
                      <span
                        >Desconto: -{{
                          contract!.descountFixe | number : "1.2-2"
                        }}</span
                      >
                    </div>

                    <div class="value-row">
                      <i class="pi pi-dollar"></i>
                      <span
                        >L√≠quido:
                        {{ contract!.liquidPrice | number : "1.2-2" }}</span
                      >
                    </div>
                  </div>
                </div>

                <div class="info-item">
                  <span class="label">Data de Assinatura / In√≠cio</span>
                  <span class="value">
                    {{ contract!.dateSignature | date : "dd/MM/yyyy" }} -
                    {{ contract!.dateStart | date : "dd/MM/yyyy" }}
                  </span>
                </div>

                <div class="info-item">
                  <span class="label">Vig√™ncia</span>
                  <span class="value">{{ contract!.vigencia }} meses</span>
                </div>

                <div class="info-item">
                  <span class="label">Ciclo de Faturamento</span>
                  <span class="value highlight">
                    Dia base: {{ contract!.cicleBillingDayBase }} / Dia de
                    Vencimento: {{ contract!.cicleBillingExpired }}
                  </span>
                </div>

                <div class="select-wrapper">
                  <p-select
                    [options]="typesOfDateExpirationCicle"
                    optionLabel="descricao"
                    optionValue="value"
                    placeholder="Selecione nova data de vencimento"
                    styleClass="custom-select"
                    [(ngModel)]="selectedBillingCycle"
                    (onChange)="onBillingCycleChange()"
                  ></p-select>
                </div>

                <div class="selected-info" *ngIf="selectedBillingCycle">
                  <i class="pi pi-calendar"></i>
                  <span>
                    Novo dia base selecionado:
                    {{ selectedBillingCycle }}
                  </span>
                </div>

                <div class="proportional-explanation">
                  <p>
                    O valor abaixo √© calculado proporcionalmente ao per√≠odo
                    restante do m√™s atual. Considera-se o valor l√≠quido do
                    contrato dividido pela quantidade de dias [30], multiplicado
                    pelo n√∫mero de dias at√© o novo dia base escolhido.
                  </p>
                </div>

                <div
                  class="proportional-info"
                  *ngIf="proportionalBoleto !== null"
                >
                  <i class="pi pi-dollar"></i>
                  <span>
                    Valor Proporcional:
                    {{
                      proportionalBoleto | currency : "BRL" : "symbol" : "1.2-2"
                    }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Bot√£o pr√≥ximo -->
            <div class="btn-actions">
              <p-button
                severity="success"
                rounded="true"
                raised="true"
                size="large"
                icon="pi pi-arrow-right"
                iconPos="right"
                label="Pr√≥ximo"
                (onClick)="activateCallback(2)"
                [disabled]="!selectedBillingCycle"
              ></p-button>
            </div>
          </ng-template>
        </p-step-panel>

        <p-step-panel [value]="2">
          <ng-template #content>
            <div *ngIf="selectedBillingCycle; else noDateSelected">
              <!-- Conte√∫do real do passo 2 -->
              <p class="step2-info">
                üìå <strong>Op√ß√µes de envio do termo:</strong><br />
                - Caso a comunica√ß√£o com o cliente seja por WhatsApp, utilize a
                op√ß√£o <strong>Autentique</strong>.<br />
                - Para apenas visualizar o termo, utilize
                <strong>Visualizar PDF</strong>.<br />
                - Se o cliente estiver presencial, utilize a op√ß√£o de
                <strong>assinatura manual</strong>, que ser√° inserida
                automaticamente no documento.
              </p>

              <div class="btn-actions">
                <!-- Visualizar / Baixar PDF -->
                <p-button
                  label="Visualizar PDF"
                  icon="pi pi-file-pdf"
                  severity="success"
                  [raised]="true"
                  rounded="true"
                  (onClick)="getConsentTermPdf()"
                ></p-button>

                <!-- Enviar para API autenticada -->
                <p-button
                  label="Autentique"
                  icon="pi pi-send"
                  severity="warn"
                  rounded="true"
                  [raised]="true"
                  (onClick)="abrirModal()"
                ></p-button>
              </div>
            </div>

            <ng-template #noDateSelected>
              <div class="alert-warning">
                ‚ö†Ô∏è Para acessar este passo, volte ao passo anterior e selecione
                a nova data de vencimento.
              </div>
            </ng-template>
          </ng-template>
        </p-step-panel>

        <p-step-panel [value]="3">
          <!-- Conte√∫do da etapa 3 -->
        </p-step-panel>

        <p-step-panel [value]="4">
          <!-- Conte√∫do da etapa 4 -->
        </p-step-panel>
      </p-step-panels>
    </p-stepper>
  </app-card-base>

  <!-- Modal -->
  <p-dialog
    header="Enviar Via WhatsApp ‚öôÔ∏è"
    [(visible)]="modalVisible"
    [modal]="true"
    [closable]="true"
    resizable="false"
    [draggable]="false"
  >
    <div class="dialog-content">
      <!-- √çcone WhatsApp -->
      <div class="icon-container">
        <i class="pi pi-whatsapp whatsapp-icon"></i>
      </div>

      <!-- Mensagem informativa -->
      <p class="info-text">
        Digite o n√∫mero no formato <strong>+55</strong> (DDD + N√∫mero). <br />
        O termo ser√° enviado pela Autentique para o cliente assinar via
        WhatsAppüìÑ‚úÖ
      </p>

      <p-inputgroup>
        <p-inputgroup-addon>
          <i class="pi pi-whatsapp"></i>
        </p-inputgroup-addon>

        <input
          pInputText
          id="telefone"
          name="telefone" 
          placeholder="+55 (DDD) 00000-0000"
          [(ngModel)]="phone"
          required
          [style]="{ height: '40px', 'font-size': '20px' }"
          mask="00000000000"
          prefix="+55"
        />
      </p-inputgroup>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        severity="secondary"
        (onClick)="fecharModal()"
      ></p-button>
      <p-button
        label="Enviar"
        icon="pi pi-send"
        severity="success"
        [disabled]="!phone || phone.trim().length < 10"
        (onClick)="sendToAutentiqueSubmit()"
      ></p-button>
    </ng-template>
  </p-dialog>
</div>
