<div class="page-container">
  <p-toast />
  <p-confirmDialog></p-confirmDialog>
  <app-card-base width="auto" height="auto">
    <p-divider>
      <div class="title">
        <h1>- CONTRATOS -</h1>
      </div>
    </p-divider>

    <div class="btn-to-create-another-contract">
      <p-button [rounded]="true" [raised]="true" (onClick)="navigateToInfoClient()" icon="pi pi-arrow-left"
        severity="danger" />
      <p-button [raised]="true" label="Criar Contrato" (onClick)="navigateToCreatContract()" icon="pi pi-plus"
        severity="success" />
    </div>

    <div class="infolegends">
      <p><span class="status-dot active"></span> Ativo</p>
      <p><span class="status-dot waiting"></span> Aguardando InstalaÃ§Ã£o</p>
      <p><span class="status-dot canceled"></span> Cancelado</p>
      <p><span class="status-dot blocked"></span> Bloqueado</p>
      <p><span class="status-dot transfer"></span> Transferido</p>
    </div>

    <div class="headerlist">
      <p-button [raised]="true" label="Somente Ativos" (onClick)="listActivesContracts()" icon="pi pi-list"
        severity="info" />
      <p-button [raised]="true" label="Visualizar todos" (onClick)="listToAllContracts()" icon="pi pi-list"
        severity="secondary" />
      <p-button [raised]="true" label="Bloqueados" (onClick)="listBlockedsContracts()" icon="pi pi-list"
        severity="secondary" />
      <p-button [raised]="true" label="Transferidos" (onClick)="listTransferContracts()" icon="pi pi-list"
        severity="secondary" />
    </div>

    <div class="contracts-list">
      @if (contracts.length === 0) {
      <div class="no-contracts">
        ğŸš« NÃƒO HÃ CONTRATOS CADASTRADO COM ESSE STATUS ğŸš«
      </div>
      } @else { @for (contract of contracts; track $index) {
      <div class="contract-card">
        <div class="contract-info">
          <div class="wrapper status-wrapper">
            <div class="status">
              <span class="status-dot" [ngClass]="{
                  active: contract.situationDescription == 'ATIVO',
                  waiting:
                    contract.situationDescription == 'AGUARDANDO_INSTALACAO',
                  blocked: contract.situationDescription == 'BLOQUEADO',
                  transfer: contract.situationDescription == 'TRANSFERIDO'
                }"></span>
              <label>[{{ contract.situationDescription }}] NÂ° Contrato ğŸ“œ (RBX)
                â†’</label>
              <span>{{ contract.codeContractRbx }}</span>
            </div>
          </div>

          <div class="addresscontract">
            <!-- Plano -->
            <div class="section">
              <label>ğŸ“¦ Plano:</label>
              <span>{{ contract.planId }} | {{ contract.planName }}</span>
            </div>

            <!-- EndereÃ§o -->
            <div class="section">
              <label>ğŸ“ EndereÃ§o:</label>
              <span>{{ contract.street }}, {{ contract.number }}</span>
            </div>

            <!-- Bairro e CEP -->
            <div class="section">
              <label>ğŸ˜ï¸ Bairro:</label>
              <span>{{ contract.neighborhood }}</span>
              <label>ğŸ“ª CEP:</label>
              <span>{{ contract.zipCode }}</span>
            </div>

            
            <div class="section section-inline">
              <div class="group">
                <label>ğŸŒ† Cidade:</label>
                <span>{{ contract.city }}, {{ contract.state }}</span>
              </div>

              <div class="group">
                <label>VigÃªncia:</label>
                <span>{{ contract.vigencia }} </span>
              </div>

              <div class="group">
                <label>Dia Base:</label>
                <span>{{ contract.cicleBillingDayBase }}</span>
              </div>

              <div class="group">
                <label>Dia Vencimento:</label>
                <span>{{ contract.cicleBillingExpired }}</span>
              </div>
            </div>

            <!-- Valores -->
            <div class="section">
              <label>ğŸ’° Valor Bruto:</label>
              <span>{{ contract.brutePrice | currency : "BRL" }}</span>
              <label>ğŸ’¸ Desconto:</label>
              <span>{{ contract.descountFixe | currency : "BRL" }}</span>
              <label>ğŸ’µ Valor LÃ­quido:</label>
              <span>{{ contract.liquidPrice | currency : "BRL" }}</span>
            </div>

            <div class="section">
              <label>InÃ­cio:</label>
              <span>{{ contract.dateStart | date : "dd/MM/yyyy" }}</span>

              <label>Assinatura:</label>
              <span>{{ contract.dateSignature | date : "dd/MM/yyyy" }}</span>
            </div>
          </div>
        </div>

        <div class="contract-actions">
          <p-button icon="pi pi-arrow-up" (onClick)="openUpgradeDialog(contract, true)" severity="success"
            [rounded]="true" [text]="true" pTooltip="Fazer Upgrade" tooltipPosition="top" />
          <p-button icon="pi pi-arrow-down" (onClick)="openUpgradeDialog(contract, false)" severity="danger"
            [rounded]="true" [text]="true" pTooltip="Fazer Downgrade" tooltipPosition="top" />
          <p-button icon="pi pi-home" (onClick)="navigateToAddressTransfer()" severity="warn" [rounded]="true"
            [text]="true" pTooltip="Transferir EndereÃ§o" tooltipPosition="top" />
          <p-button icon="pi pi-calendar" (onClick)="goToAlterDateExpired(contract)" severity="success" [rounded]="true"
            [text]="true" pTooltip="Alterar Vencimento" tooltipPosition="top">
          </p-button>
          <p-button icon="pi pi-users" (onClick)="openTransferDialog(contract)" severity="info" [rounded]="true"
            [text]="true" pTooltip="Transferir Titularidade" tooltipPosition="top">
          </p-button>
        </div>
      </div>
      } }
    </div>
  </app-card-base>
</div>

<!-- Transferir titluatriade DIALOGO  -->
<p-dialog
  header="Transferir Titularidade"
  [(visible)]="transferDialogVisible"
  [modal]="true"
  [style]="{ width: '50rem' }" (onHide)="closeTransferDialog()"
>

  <p-stepper [value]="activeStepIndex + 1">
    <p-step-list>
        <p-step [value]="1">Buscar Cliente</p-step>
        <p-step [value]="2">Termo de Consentimento</p-step>
        <p-step [value]="3">ConfirmaÃ§Ã£o</p-step>
    </p-step-list>
  </p-stepper>

  <!-- Usamos *ngIf para controlar manualmente qual painel Ã© exibido -->
  <div class="step-panels-container">
    <div *ngIf="activeStepIndex === 0" class="step-panel-content">
      <div class="step-content">
        <p>Digite o documento do novo titular para iniciar a transferÃªncia.</p>
        <div class="form-group-input" style="width: 100%; margin-top: 1.5rem;">
            <p-iftalabel variant="on" style="width: 100%">
              <input
                pInputText
                id="documento"
                [(ngModel)]="documento"
                name="documento"
                required
                minlength="14"
                maxlength="18"
                placeholder="CPF/CNPJ"
                (ngModelChange)="formatarDocumento($event)"
                (keypress)="allowOnlyNumbers($event)"
                (paste)="onPaste($event)"
                autocomplete="off"
              />
              <label for="documento"></label>
            </p-iftalabel>
        </div>
      </div>
      <div class="step-footer">
        <p-button label="Buscar" [rounded]="true" severity="info" icon="pi pi-search" (onClick)="onSearchNewOwner()" [loading]="isLoadingTransfer"></p-button>
        <p-button label="PrÃ³ximo"  [rounded]="true" severity="success" icon="pi pi-arrow-right" (onClick)="goToConsentStep()" [disabled]="!foundClient"></p-button>
      </div>
    </div>

    <!-- PAINEL 2: Termo de Consentimento -->
    <div *ngIf="activeStepIndex === 1" class="step-panel-content">
      <div class="step-content">
        <div *ngIf="isLoadingPdf" class="pdf-loading">
          <p-progressSpinner></p-progressSpinner>
          <span>Gerando termo de consentimento...</span>
        </div>
        <div *ngIf="pdfSrc" class="pdf-viewer">
          <iframe [src]="pdfSrc" width="100%" height="500px"></iframe>
        </div>
        <div *ngIf="!isLoadingPdf" class="p-field-checkbox consent-check">
          <p-checkbox [(ngModel)]="consentAgreed" binary="true" inputId="consentCheck"></p-checkbox>
          <label for="consentCheck">Declaro que li e concordo com os termos apresentados no documento.</label>
        </div>
      </div>
      <div class="step-footer">
        <p-button [rounded]="true" label="Voltar" icon="pi pi-arrow-left" (onClick)="goBackStep(0)" [text]="true"></p-button>
        <p-button [rounded]="true" severity="success" label="PrÃ³ximo" icon="pi pi-arrow-right" (onClick)="activeStepIndex = 2" [disabled]="!consentAgreed"></p-button>
      </div>
    </div>

    <!-- PAINEL 3: ConfirmaÃ§Ã£o -->
    <div *ngIf="activeStepIndex === 2" class="step-panel-content">
      <div class="step-content confirmation-step">
        <i class="pi pi-check-circle success-icon"></i>
        <h3>Tudo pronto para a transferÃªncia!</h3>
        <p>
          O termo de consentimento foi gerado. Ao clicar em "Efetivar TransferÃªncia", a titularidade do contrato
          serÃ¡ alterada para <strong>{{ foundClient?.name }}</strong>.
        </p>
      </div>
      <div class="step-footer">
        <p-button [rounded]="true" label="Voltar" icon="pi pi-arrow-left" (onClick)="goBackStep(1)" [text]="true"></p-button>
        <p-button [rounded]="true" severity="success" label="Efetivar TransferÃªncia" icon="pi pi-check" (onClick)="onConfirmTransfer()" [loading]="isLoadingTransfer"></p-button>
      </div>
    </div>

  </div>
</p-dialog>

<!-- UPGRADE/DOWNGRADE -->
<p-dialog [header]="dialogTitle" [(visible)]="upgradeDialog" [modal]="true" (onHide)="onHide()"
  [style]="{ width: '38rem' }" [draggable]="false">
  <form [formGroup]="upgradeForm" (ngSubmit)="submitUpgrade()">
    <div class="dialog-container">
      <div class="p-fluid form-grid">
        <div class="grid">
          <div class="col-6">
            <div class="form-group-contract">
              <label for="contract">NÂº do Contrato: </label>
              <span class="contract-code">{{ selectedContractForUpgrade?.codeContractRbx }}</span>
            </div>
          </div>
          <div class="col-6">
            <div class="form-group">
              <label for="codePlan">CÃ³digo do Plano:</label>
              <p-inputNumber inputId="codePlan" formControlName="codePlan"></p-inputNumber>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="descountFixe">Desconto Fixo (R$)</label>
          <p-inputNumber inputId="descountFixe" formControlName="descountFixe" mode="currency" currency="BRL"
            locale="pt-BR"></p-inputNumber>
        </div>

        <div class="grid">
          <div class="col-6">
            <div class="form-group">
              <label for="cicleFatId">Ciclo de Faturamento:</label>
              <p-select id="expirationCycle" formControlName="expirationCycle"
                placeholder="Selecionar ciclo de vencimento" [options]="typesOfDateExpirationCicle"
                optionLabel="descricao" appendTo="body">
              </p-select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" icon="pi pi-times" (click)="onHide()" severity="danger">
    </p-button>

    <p-button label="Confirmar AlteraÃ§Ã£o" icon="pi pi-check" type="submit" [disabled]="upgradeForm.invalid"
      (click)="submitUpgrade()" severity="success">
    </p-button>
  </ng-template>
</p-dialog>
<p-toast />

<p-dialog header="Alterar Data de Vencimento" [(visible)]="dialogBilling" [modal]="true" [resizable]="false"
  [draggable]="false">
  <div class="dialog-content">
    <!-- Container para Ã­cone acima do select -->
    <div class="select-with-icon">
      <div class="warn-icon-container">
        <span class="warn-icon" (click)="toggle(pop3, $event)" role="button" aria-label="InformaÃ§Ã£o importante">
          !
        </span>
        <p-popover #pop3 [dismissable]="true">
          <div class="warn-popup">
            Exemplo:<br />
            <strong>01 a 31 / 01</strong><br /><br />
            <strong>01</strong> â€” InÃ­cio do ciclo<br />
            <strong>31</strong> â€” Vencimento<br />
            <strong>01</strong> â€” Data de pagamento
          </div>
        </p-popover>
      </div>

      <p-select [options]="typesOfDateExpirationCicle" [appendTo]="'body'" optionLabel="descricao" optionValue="value"
        placeholder="Selecione um Ciclo" [(ngModel)]="selectedBillingCycle"></p-select>
    </div>

    <div>
      <button pButton label="Trocar" class="p-button-warning" (click)="confirmTransferDate(selectedContract)"></button>
    </div>
  </div>
</p-dialog>

<!-- Overlay Global -->
<div class="global-overlay" *ngIf="loadingBillingDialog">
  <p-progressSpinner strokeWidth="4" animationDuration=".5s"
    [style]="{ width: '200px', height: '200px' }"></p-progressSpinner>
  <span class="global-overlay-message">
    [âš™ï¸] Aguarde enquanto a automaÃ§Ã£o altera os dados.
  </span>
</div>