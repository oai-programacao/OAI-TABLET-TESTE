<div class="page-container">
  <p-toast />
  <p-confirmDialog></p-confirmDialog>
  <app-card-base width="auto" height="auto">
    <p-divider>
      <div class="title">
        <h1>- CONTRATOS -</h1>
      </div>
    </p-divider>

    <div class="btn-to-create-another-contract">
      <p-button [rounded]="true" [raised]="true" (onClick)="navigateToInfoClient()" icon="pi pi-arrow-left"
        severity="danger" />
      <p-button [raised]="true" label="Criar Contrato" (onClick)="navigateToCreatContract()" icon="pi pi-plus"
        severity="success" />
    </div>

    <div class="infolegends">
      <p><span class="status-dot active"></span> Ativo</p>
      <p><span class="status-dot waiting"></span> Aguardando InstalaÃ§Ã£o</p>
      <p><span class="status-dot canceled"></span> Cancelado</p>
      <p><span class="status-dot blocked"></span> Bloqueado</p>
      <p><span class="status-dot transfer"></span> Transferido</p>
    </div>

    <div class="headerlist">
      <p-button [raised]="true" label="Somente Ativos" (onClick)="listActivesContracts()" icon="pi pi-list"
        severity="info" />
      <p-button [raised]="true" label="Visualizar todos" (onClick)="listToAllContracts()" icon="pi pi-list"
        severity="secondary" />
      <p-button [raised]="true" label="Bloqueados" (onClick)="listBlockedsContracts()" icon="pi pi-list"
        severity="secondary" />
      <p-button [raised]="true" label="Transferidos" (onClick)="listTransferContracts()" icon="pi pi-list"
        severity="secondary" />
    </div>

    <div class="contracts-list">
      @if (contracts.length === 0) {
      <div class="no-contracts">
        ğŸš« NÃƒO HÃ CONTRATOS CADASTRADO COM ESSE STATUS ğŸš«
      </div>
      } @else { @for (contract of contracts; track $index) {
      <div class="contract-card">
        <div class="contract-info">
          <div class="wrapper status-wrapper">
            <div class="status">
              <span class="status-dot" [ngClass]="{
                  active: contract.situationDescription == 'ATIVO',
                  waiting:
                    contract.situationDescription == 'AGUARDANDO_INSTALACAO',
                  blocked: contract.situationDescription == 'BLOQUEADO',
                  transfer: contract.situationDescription == 'TRANSFERIDO'
                }"></span>
              <label>[{{ contract.situationDescription }}] NÂ° Contrato ğŸ“œ (RBX)
                â†’</label>
              <span>{{ contract.codeContractRbx }}</span>
            </div>
          </div>

          <div class="addresscontract">
            <!-- Plano -->
            <div class="section">
              <label>ğŸ“¦ Plano:</label>
              <span>{{ contract.planId }} | {{ contract.planName }}</span>
            </div>

            <!-- EndereÃ§o -->
            <div class="section">
              <label>ğŸ“ EndereÃ§o:</label>
              <span>{{ contract.street }}, {{ contract.number }}</span>
            </div>

            <!-- Bairro e CEP -->
            <div class="section">
              <label>ğŸ˜ï¸ Bairro:</label>
              <span>{{ contract.neighborhood }}</span>
              <label>ğŸ“ª CEP:</label>
              <span>{{ contract.zipCode }}</span>
            </div>

            <!-- EndereÃ§o + VigÃªncia + Vencimento + Dia Base -->
            <div class="section section-inline">
              <div class="group">
                <label>ğŸŒ† Cidade:</label>
                <span>{{ contract.city }}, {{ contract.state }}</span>
              </div>

              <div class="group">
                <label>VigÃªncia:</label>
                <span>{{ contract.vigencia }} </span>
              </div>

              <div class="group">
                <label>Dia Base:</label>
                <span>{{ contract.cicleBillingDayBase }}</span>
              </div>

              <div class="group">
                <label>Dia Vencimento:</label>
                <span>{{ contract.cicleBillingExpired }}</span>
              </div>
            </div>

            <!-- Valores -->
            <div class="section">
              <label>ğŸ’° Valor Bruto:</label>
              <span>{{ contract.brutePrice | currency : "BRL" }}</span>
              <label>ğŸ’¸ Desconto:</label>
              <span>{{ contract.descountFixe | currency : "BRL" }}</span>
              <label>ğŸ’µ Valor LÃ­quido:</label>
              <span>{{ contract.liquidPrice | currency : "BRL" }}</span>
            </div>

            <div class="section">
              <label>InÃ­cio:</label>
              <span>{{ contract.dateStart | date : "dd/MM/yyyy" }}</span>

              <label>Assinatura:</label>
              <span>{{ contract.dateSignature | date : "dd/MM/yyyy" }}</span>
            </div>
          </div>
        </div>

        <div class="contract-actions">
          <p-button icon="pi pi-arrow-up" (onClick)="openUpgradeDialog(contract, true)" severity="success"
            [rounded]="true" [text]="true" pTooltip="Fazer Upgrade" tooltipPosition="top" />
          <p-button icon="pi pi-arrow-down" (onClick)="openUpgradeDialog(contract, false)" severity="danger"
            [rounded]="true" [text]="true" pTooltip="Fazer Downgrade" tooltipPosition="top" />
          <p-button icon="pi pi-home" (onClick)="navigateToAddressTransfer()" severity="warn" [rounded]="true"
            [text]="true" pTooltip="Transferir EndereÃ§o" tooltipPosition="top" />
          <p-button icon="pi pi-calendar" (onClick)="goToAlterDateExpired(contract)" severity="success" [rounded]="true"
            [text]="true" pTooltip="Alterar Vencimento" tooltipPosition="top">
          </p-button>
          <p-button icon="pi pi-users" (onClick)="openTransferDialog(contract)" severity="info" [rounded]="true"
            [text]="true" pTooltip="Transferir Titularidade" tooltipPosition="top">
          </p-button>
        </div>
      </div>
      } }
    </div>
  </app-card-base>
</div>

<!-- Transferir titluatriade DIALOGO  -->
<p-dialog
  header="Transferir Titularidade"
  [(visible)]="transferDialogVisible"
  [modal]="true"
  [style]="{ width: '30rem' }"
  [draggable]="false"
  (onHide)="closeTransferDialog()"
  styleClass="transfer-dialog-wrapper"
>
  <div class="transfer-dialog">
    <div class="transfer-dialog__header">
      <label>Contrato a ser transferido:</label>
      <span>#{{ selectedContractForTransfer?.codeContractRbx }}</span>
    </div>

    <div class="transfer-dialog__content">
      <div *ngIf="isLoadingTransfer" class="transfer-dialog__loading-overlay">
        <p-progressSpinner strokeWidth="4"></p-progressSpinner>
        <span class="loading-message">{{ loadingMessage }}</span>
      </div>

      <ng-container [ngSwitch]="transferStep">
        <div *ngSwitchCase="'search'" class="transfer-dialog__step">
          <div class="form-group-input" style="width: 100%;">
            <p-iftalabel variant="on" style="width: 100%">
              <input
                pInputText
                id="documento"
                [(ngModel)]="documento"
                name="documento"
                required
                minlength="14"
                maxlength="18"
                placeholder="CPF/CNPJ"
                (ngModelChange)="formatarDocumento($event)"
                (keypress)="allowOnlyNumbers($event)"
                (paste)="onPaste($event)"
                autocomplete="off"
              />
              <label for="documento"></label>
            </p-iftalabel>
          </div>
        </div>

        <!-- Outras etapas (confirm, notFound, success) -->
        <div *ngSwitchCase="'confirm'" class="transfer-dialog__step">
            <p class="transfer-dialog__label">Transferir para o cliente:</p>
            <p class="transfer-dialog__name">{{ foundClient?.name }}</p>
        </div>
        <div *ngSwitchCase="'notFound'" class="transfer-dialog__step">
            <i class="pi pi-exclamation-triangle transfer-dialog__icon--error"></i>
            <p class="transfer-dialog__message--error">Cliente nÃ£o encontrado.</p>
            <p class="transfer-dialog__subtext">Deseja cadastrÃ¡-lo agora?</p>
        </div>
        <div *ngSwitchCase="'success'" class="transfer-dialog__step">
            <i class="pi pi-check-circle transfer-dialog__icon--success"></i>
            <p class="transfer-dialog__message--success">TransferÃªncia ConcluÃ­da!</p>
        </div>

      </ng-container>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cancelar" icon="pi pi-times" (click)="closeTransferDialog()" severity="danger"></p-button>
    <p-button *ngIf="transferStep === 'search'" label="Buscar Cliente" icon="pi pi-search"
      (click)="onSearchClientByCpf()" severity="success"></p-button>
    <p-button *ngIf="transferStep === 'confirm'" label="Confirmar TransferÃªncia" icon="pi pi-check"
      (click)="onConfirmTransfer()" severity="success"></p-button>
    <p-button *ngIf="transferStep === 'notFound'" label="Cadastrar Cliente" icon="pi pi-user-plus"
      (click)="navigateToCreateClient()" severity="help"></p-button>
  </ng-template>
</p-dialog>

<!-- UPGRADE/DOWNGRADE -->
<p-dialog [header]="dialogTitle" [(visible)]="upgradeDialog" [modal]="true" (onHide)="onHide()"
  [style]="{ width: '38rem' }" [draggable]="false">
  <form [formGroup]="upgradeForm" (ngSubmit)="submitUpgrade()">
    <div class="dialog-container">
      <div class="p-fluid form-grid">
        <div class="grid">
          <div class="col-6">
            <div class="form-group-contract">
              <label for="contract">NÂº do Contrato: </label>
              <span class="contract-code">{{ selectedContractForUpgrade?.codeContractRbx }}</span>
            </div>
          </div>
          <div class="col-6">
            <div class="form-group">
              <label for="codePlan">CÃ³digo do Plano:</label>
              <p-inputNumber inputId="codePlan" formControlName="codePlan"></p-inputNumber>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="descountFixe">Desconto Fixo (R$)</label>
          <p-inputNumber inputId="descountFixe" formControlName="descountFixe" mode="currency" currency="BRL"
            locale="pt-BR"></p-inputNumber>
        </div>

        <div class="grid">
          <div class="col-6">
            <div class="form-group">
              <label for="cicleFatId">Ciclo de Faturamento:</label>
              <p-select id="expirationCycle" formControlName="expirationCycle"
                placeholder="Selecionar ciclo de vencimento" [options]="typesOfDateExpirationCicle"
                optionLabel="descricao" appendTo="body">
              </p-select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" icon="pi pi-times" (click)="onHide()" severity="danger">
    </p-button>

    <p-button label="Confirmar AlteraÃ§Ã£o" icon="pi pi-check" type="submit" [disabled]="upgradeForm.invalid"
      (click)="submitUpgrade()" severity="success">
    </p-button>
  </ng-template>
</p-dialog>
<p-toast />

<p-dialog header="Alterar Data de Vencimento" [(visible)]="dialogBilling" [modal]="true" [resizable]="false"
  [draggable]="false">
  <div class="dialog-content">
    <!-- Container para Ã­cone acima do select -->
    <div class="select-with-icon">
      <div class="warn-icon-container">
        <span class="warn-icon" (click)="toggle(pop3, $event)" role="button" aria-label="InformaÃ§Ã£o importante">
          !
        </span>
        <p-popover #pop3 [dismissable]="true">
          <div class="warn-popup">
            Exemplo:<br />
            <strong>01 a 31 / 01</strong><br /><br />
            <strong>01</strong> â€” InÃ­cio do ciclo<br />
            <strong>31</strong> â€” Vencimento<br />
            <strong>01</strong> â€” Data de pagamento
          </div>
        </p-popover>
      </div>

      <p-select [options]="typesOfDateExpirationCicle" [appendTo]="'body'" optionLabel="descricao" optionValue="value"
        placeholder="Selecione um Ciclo" [(ngModel)]="selectedBillingCycle"></p-select>
    </div>

    <div>
      <button pButton label="Trocar" class="p-button-warning" (click)="confirmTransferDate(selectedContract)"></button>
    </div>
  </div>
</p-dialog>

<!-- Overlay Global -->
<div class="global-overlay" *ngIf="loadingBillingDialog">
  <p-progressSpinner strokeWidth="4" animationDuration=".5s"
    [style]="{ width: '200px', height: '200px' }"></p-progressSpinner>
  <span class="global-overlay-message">
    [âš™ï¸] Aguarde enquanto a automaÃ§Ã£o altera os dados.
  </span>
</div>